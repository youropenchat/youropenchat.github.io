<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenChat</title>

  <!-- Cloudinary Upload Widget SDK -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

  <style>
    /* --- Genel Ayarlar --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1e2124;
      color: #e1e3e5;
    }
    button, input, select, textarea {
      outline: none;
      font-family: inherit;
    }

    /* --- Ortak Buton Stili (t√ºm butonlara uygulanacak) --- */
    .btn {
      display: inline-block;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background-color: #4f86f7;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      text-align: center;
      text-decoration: none;
      user-select: none;
    }
    .btn:hover {
      background-color: #3e6edc;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .btn.danger {
      background-color: #e54b4b;
    }
    .btn.danger:hover {
      background-color: #c43f3f;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
    }

    /* --- Koyu ve A√ßƒ±k Tema Renkleri --- */
    body.light-mode {
      background-color: #f4f4f4;
      color: #222;
    }
    body.light-mode #userControls { background-color: #e0e0e0; }
    body.light-mode #messages { background: #fafafa; }
    body.light-mode .message { background: #ddd; color: #222; }
    body.light-mode .message .header .author { color: #0057e7; }
    body.light-mode #inputArea { background-color: #e0e0e0; }
    body.light-mode #searchInput { background-color: #fff; color: #222; }
    body.light-mode .modal { background: #fff; color: #222; }
    body.light-mode .modal input, body.light-mode .modal select { background: #eee; color: #222; }
    body.light-mode .modal button { background: #0057e7; }
    body.light-mode .modal .danger-btn { background-color: #d62828; }
    body.light-mode #mentionPopup { background-color: #0057e7; color: #fff; }
    body.light-mode #typingIndicator, body.light-mode #onlineCount { color: #555; }

    /* --- Modal Arka Plan --- */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .modal {
      background: #2f3438;
      border-radius: 8px;
      padding: 20px 30px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      text-align: center;
    }
    .modal h2 {
      margin-bottom: 15px;
      font-size: 22px;
      color: #ffffff;
    }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      margin: 8px 0;
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 14px;
    }
    .modal button {
      width: 100%;
      margin: 8px 0;
      padding: 8px 10px;
      border: none;
      border-radius: 6px;
      background-color: #4f86f7;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal button:hover {
      background-color: #3e6edc;
    }
    .modal .danger-btn {
      background-color: #e54b4b;
    }
    .modal .danger-btn:hover {
      background-color: #c43f3f;
    }
    .modal .error {
      margin-top: 8px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Sohbet Ekranƒ± --- */
    #chat {
      display: none; /* Giri≈ü sonrasƒ± JS ile 'flex' yapƒ±lƒ±yor */
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #1e2124;
    }
    #userControls {
      background: #292d31;
      padding: 8px 12px;
      display: none;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #3a3f45;
    }
    #userControls .btn {
      margin-right: 6px;
    }
    #toggleAdminBtn {
      background-color: #d62828;
    }
    #toggleAdminBtn:hover {
      background-color: #b21818;
    }
    #onlineCount {
      margin-left: auto;
      font-size: 12px;
      color: #9aa0a6;
    }
    #typingIndicator {
      font-size: 12px;
      color: #9aa0a6;
      padding: 4px 12px;
      display: none;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #1e2124;
      position: relative;
    }
    .message {
      background: #2f3438;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      position: relative;
      word-wrap: break-word;
    }
    .message .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .message .header .author {
      color: #4f86f7;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }
    .role-tag {
      margin-left: 4px;
      font-size: 11px;
      font-weight: bold;
      color: #faa61a;
    }
    .message .header .time {
      font-size: 10px;
      color: #9aa0a6;
    }
    .message .content {
      margin-top: 4px;
      font-size: 13px;
      line-height: 1.4;
      color: #e1e3e5;
    }
    .message img {
      max-width: 200px;
      border-radius: 8px;
      margin-top: 6px;
    }
    .message.mention .content {
      color: #faa61a;
      font-weight: 600;
    }
    .message .actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    .message .actions .btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .message .actions .delete-btn {
      background: #e54b4b;
    }
    .message .actions .delete-btn:hover {
      background: #c43f3f;
    }
    .message .actions .edit-btn {
      background: #4f86f7;
    }
    .message .actions .edit-btn:hover {
      background: #3e6edc;
    }
    .message.mention {
      background: #3b3f44;
    }

    #inputArea {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background-color: #2b2f33;
      border-top: 1px solid #3a3f45;
      position: relative;
    }
    #messageInput {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 13px;
    }
    #sendBtn {
      margin-left: 8px;
    }

    /* --- Cloudinary Dosya Se√ßme ve Y√ºkle --- */
    #fileInput {
      margin-left: 8px;
      font-size: 13px;
      color: #ddd;
      background: #3b3f44;
      border: 1px solid #3a3f45;
      border-radius: 4px;
      padding: 4px;
      cursor: pointer;
    }
    #uploadFileBtn {
      margin-left: 4px;
      padding: 6px 10px;
    }

    /* --- Profil Popup --- */
    #profilePopup {
      position: fixed;
      background-color: #292d31;
      color: #fff;
      border: 1px solid #3a3f45;
      border-radius: 8px;
      padding: 12px;
      display: none;
      z-index: 20;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #profilePopup .username {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    #profilePopup .register-date {
      text-align: center;
      font-size: 11px;
      color: #9aa0a6;
      margin-bottom: 6px;
    }
    #profilePopup .days-since {
      text-align: center;
      font-size: 11px;
      color: #9aa0a6;
      margin-bottom: 6px;
    }
    #profilePopup .status {
      text-align: center;
      font-size: 12px;
      color: #9aa0a6;
      margin-bottom: 8px;
    }
    #profilePopup .btn {
      margin-top: 6px;
      font-size: 12px;
      padding: 6px 8px;
    }

    /* --- ≈ûifre Deƒüi≈ütir Popup --- */
    #changePasswordPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #changePasswordPopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #changePasswordPopup input {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 14px;
    }
    #changePasswordPopup .btn {
      width: 100%;
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    #changePasswordPopup .danger-btn {
      background-color: #e54b4b;
    }
    #changePasswordPopup .danger-btn:hover {
      background-color: #c43f3f;
    }
    #changePasswordPopup .error {
      margin-top: 8px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Kullanƒ±cƒ± Adƒ± Deƒüi≈ütir Popup --- */
    #changeUsernamePopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: false;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #changeUsernamePopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #changeUsernamePopup input {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 14px;
    }
    #changeUsernamePopup .btn {
      width: 100%;
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    #changeUsernamePopup .danger-btn {
      background-color: #e54b4b;
    }
    #changeUsernamePopup .danger-btn:hover {
      background-color: #c43f3f;
    }
    #changeUsernamePopup .error {
      margin-top: 8px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Mesajlarƒ±m Popup --- */
    #myMessagesPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #myMessagesPopup .modal {
      width: 90%;
      max-width: 400px;
    }
    #myMessagesContent {
      background: #2f3438;
      border-radius: 8px;
      max-height: 70vh;
      overflow-y: auto;
      margin-top: 12px;
      padding: 10px;
    }
    #myMessagesContent .thread {
      padding: 10px;
      border-bottom: 1px solid #3a3f45;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
      font-size: 13px;
    }
    #myMessagesContent .thread:hover {
      background: #3b3f44;
    }
    #myMessagesContent .thread:last-child {
      border-bottom: none;
    }
    #myMessagesContent .thread .badge {
      background: #4f86f7;
      border-radius: 12px;
      color: #fff;
      padding: 2px 6px;
      font-size: 11px;
    }

    /* --- Admin Panel Popup --- */
    #adminModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #adminModal .modal {
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    #adminModal .btn {
      width: 100%;
      margin: 6px 0;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    #adminModal .danger-btn {
      background-color: #e54b4b;
    }
    #adminModal .danger-btn:hover {
      background-color: #c43f3f;
    }

    /* --- Ban Listesi Popup --- */
    #banListPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #banListPopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #banListPopup .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-bottom: 1px solid #3a3f45;
      font-size: 13px;
      background: #2f3438;
      margin-bottom: 4px;
      border-radius: 4px;
    }
    #banListPopup .user-item .btn {
      padding: 4px 6px;
      font-size: 12px;
    }

    /* --- Sessize Alma Popup --- */
    #mutePopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #mutePopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #mutePopup input {
      width: 100%;
      margin: 6px 0;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 13px;
    }
    #mutePopup .btn {
      width: 100%;
      margin: 6px 0;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    #mutePopup .danger-btn {
      background-color: #e54b4b;
    }
    #mutePopup .danger-btn:hover {
      background-color: #c43f3f;
    }
    #mutePopup .error {
      margin-top: 6px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Duyuru Listesi Popup --- */
    #announcementListPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #announcementListPopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #announcementListPopup .announcement-item {
      background: #2f3438;
      padding: 6px 8px;
      border-bottom: 1px solid #3a3f45;
      margin-bottom: 4px;
      border-radius: 4px;
      text-align: left;
      font-size: 13px;
      color: #e1e3e5;
    }
    #announcementListPopup .announcement-item .btn {
      margin-top: 4px;
      font-size: 11px;
      padding: 4px 6px;
    }

    /* --- Kullanƒ±cƒ± Bilgi Popup --- */
    #userInfoPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #userInfoPopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #userInfoPopup p {
      margin: 6px 0;
      font-size: 13px;
      text-align: left;
    }

    /* --- T√ºm Kullanƒ±cƒ±lar Popup (Admin) --- */
    #allUsersPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #allUsersPopup .modal {
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    #allUsersPopup .modal div {
      max-height: 60vh;
      overflow-y: auto;
    }

    /* --- DM Kutusu --- */
    #privateChat {
      display: none;
      flex-direction: column;
      height: 100vh;
      background: #1e2124;
      color: #e1e3e5;
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      z-index: 30;
    }
    #privateChat .startChatBtn {
      margin: 8px 12px;
    }
    #privateChat .header {
      background: #292d31;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #3a3f45;
    }
    #privateChat .header span {
      font-weight: 600;
      font-size: 14px;
      color: #4f86f7;
    }
    #privateChat .header .btn {
      padding: 4px 8px;
    }
    #privateChat .messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #1e2124;
    }
    #privateChat .messages .msg {
      background: #2f3438;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      word-wrap: break-word;
      position: relative;
    }
    #privateChat .messages .msg .header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #9aa0a6;
    }
    #privateChat .messages .msg .content {
      margin-top: 4px;
      font-size: 13px;
      color: #e1e3e5;
    }
    #privateChat .messages .msg .read-status {
      font-size: 0.8em;
      color: green;
      margin-left: 5px;
    }
    #privateChat .messages .msg .actions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
    }
    #privateChat .messages .msg .actions .btn {
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
    }
    #privateChat .messages .msg .actions .delete-btn {
      background: #e54b4b;
    }
    #privateChat .messages .msg .actions .delete-btn:hover {
      background: #c43f3f;
    }
    #privateChat .messages .msg .actions .edit-btn {
      background: #4f86f7;
    }
    #privateChat .messages .msg .actions .edit-btn:hover {
      background: #3e6edc;
    }
    #privateChat .inputArea {
      display: flex;
      padding: 8px 12px;
      background: #2b2f33;
      border-top: 1px solid #3a3f45;
    }
    #privateChat .inputArea input {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 13px;
    }
    #privateChat .inputArea .btn {
      margin-left: 8px;
      padding: 8px 12px;
      font-size: 13px;
    }
    #privateChat .inputArea .btn:hover {
      background-color: #3e6edc;
    }

    /* --- Sohbete Ba≈üla Modal --- */
    #startChatModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #startChatModal .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #startChatModal input {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 14px;
    }
    #startChatModal .btn {
      width: 100%;
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    #startChatModal .danger-btn {
      background-color: #e54b4b;
    }
    #startChatModal .danger-btn:hover {
      background-color: #c43f3f;
    }
    #startChatModal .error {
      margin-top: 8px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Mobil (max-width: 600px) --- */
    @media (max-width: 600px) {
      #userControls {
        flex-wrap: wrap;
        gap: 6px;
      }
      #inputArea, #privateChat .inputArea {
        flex-direction: column;
      }
      #sendBtn, #uploadFileBtn, #privateChat .inputArea .btn {
        margin-left: 0;
        margin-top: 8px;
      }
      #messageInput, #privateChat .inputArea input {
        font-size: 13px;
      }
      .message {
        font-size: 13px;
      }
      #authModal input {
        font-size: 13px;
      }
      #authModal button {
        font-size: 12px;
        padding: 6px 8px;
      }
      #changePasswordPopup input, #changeUsernamePopup input { font-size: 13px; }
      #changePasswordPopup button, #changeUsernamePopup button { font-size: 12px; }
      #myMessagesContent { width: 95%; }
      #myMessagesContent .thread {
        font-size: 13px;
        padding: 8px;
      }
      #privateChat .header, #privateChat .inputArea {
        padding: 8px 10px;
      }
      #privateChat .inputArea .btn {
        padding: 6px 8px;
        font-size: 13px;
      }
      #privateChat .inputArea input {
        font-size: 13px;
        padding: 6px 8px;
      }
    }

    /* --- Mention Popup --- */
    #mentionPopup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4f86f7;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: none;
      z-index: 50;
      font-size: 13px;
    }
  </style>
</head>
<body>

<!-- Mention Popup -->
<div id="mentionPopup">Birisi seni etiketledi!</div>

<!-- Kayƒ±t/Giri≈ü Modalƒ± -->
<div id="authModal" class="modal-overlay">
  <div class="modal">
    <h2>OpenChat - Kayƒ±t ve Giri≈ü</h2>
    <input type="text" id="authUsername" placeholder="Kullanƒ±cƒ± adƒ±">
    <input type="password" id="authPassword" placeholder="≈ûifre">
    <label style="font-size:12px; color:#ddd;">
      <input type="checkbox" id="rememberMeLogin"> Beni hatƒ±rla
    </label>
    <button class="btn" onclick="register()">Kayƒ±t Ol</button>
    <button class="btn" onclick="login()">Giri≈ü Yap</button>
    <div id="authError" class="error"></div>
  </div>
</div>

<!-- OpenChat √ñzellikleri Pop-up (giri≈üten sonra bir kez g√∂sterilecek) -->
<div id="welcomePopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>OpenChat‚Äôe Ho≈ügeldiniz!</h2>
    <p>OpenChat, ≈üu √∂zelliklere sahiptir:</p>
    <ul style="text-align:left; margin:10px 0; font-size:14px;">
      <li>Global sohbet imk√¢nƒ±</li>
      <li>√ñzel mesaj (DM) olu≈üturma</li>
      <li>Mentions (@kullanƒ±cƒ±) ile bildirim</li>
      <li>Rol bazlƒ± ayrƒ±calƒ±klar (VIP, Moderator, Admin, Tester, BETA-TESTER)</li>
      <li>Mesaj arama ve d√ºzenleme</li>
      <li>PDF/TXT indirme (Admin i√ßin)</li>
      <li>Kayƒ±t tarihi ve ‚ÄúKa√ß g√ºn kayƒ±tlƒ±‚Äù bilgisi</li>
      <li>Beni Hatƒ±rla se√ßeneƒüi</li>
      <li>√áevrimi√ßi kullanƒ±cƒ± g√∂sterimi</li>
      <li>Basit tema (Koyu/A√ßƒ±k) ge√ßi≈üi</li>
      <li>1 saatte bir kullanƒ±cƒ± adƒ± deƒüi≈ütirme hakkƒ±</li>
    </ul>
    <button class="btn" onclick="closeWelcomePopup()">Tamam</button>
  </div>
</div>

<!-- ≈ûifre Deƒüi≈ütir Popup -->
<div id="changePasswordPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>≈ûifre Deƒüi≈ütir</h2>
    <input type="password" id="oldPassword" placeholder="Eski ≈ûifre">
    <input type="password" id="newPassword" placeholder="Yeni ≈ûifre">
    <button class="btn" onclick="changePassword()">Kaydet</button>
    <button class="btn danger-btn" onclick="closeChangePasswordPopup()">Kapat</button>
    <div id="changePassError" class="error"></div>
  </div>
</div>

<!-- Kullanƒ±cƒ± Adƒ± Deƒüi≈ütir Popup -->
<div id="changeUsernamePopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Kullanƒ±cƒ± Adƒ± Deƒüi≈ütir</h2>
    <input type="text" id="newDisplayName" placeholder="Yeni G√∂r√ºnen Ad" maxlength="20">
    <button class="btn" onclick="changeUsername()">Deƒüi≈ütir</button>
    <button class="btn danger-btn" onclick="closeChangeUsernamePopup()">Kapat</button>
    <div id="changeNameError" class="error"></div>
  </div>
</div>

<!-- Mesajlarƒ±m Popup -->
<div id="myMessagesPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>√ñzel Mesajlarƒ±m</h2>
    <div id="myMessagesContent"></div>
    <button class="btn" onclick="closeMyMessagesPopup()">Kapat</button>
  </div>
</div>

<!-- Admin Panel Modal -->
<div id="adminModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Admin Paneli</h2>
    <button class="btn" onclick="openBanList()">Ban Listesi</button>
    <button class="btn" onclick="openMutePopup()">Sessize Al</button>
    <button class="btn" onclick="lockChat()">Sohbet Kilitle / Kilidi A√ß</button>
    <button class="btn" onclick="announce()">Duyuru G√∂nder</button>
    <button class="btn" onclick="openAnnouncementList()">Duyurularƒ± Sil</button>
    <button class="btn" onclick="grantRole()">Rol Ver (VIP/Moderator/Admin/BETA-TESTER/Tester)</button>
    <button class="btn" onclick="viewChatCount()">√áevrimi√ßi Sayƒ±sƒ±</button>
    <button class="btn" onclick="openUserInfo()">Kullanƒ±cƒ± Bilgisi</button>
    <button class="btn" onclick="viewDMAdmin()">T√ºm DM‚Äôleri Oku</button>
    <button class="btn" onclick="adminChangePassword()">≈ûifre Deƒüi≈ütir</button>
    <button class="btn" onclick="impersonate()">Kullanƒ±cƒ± Hesabƒ±na Gir</button>
    <button class="btn" onclick="downloadChatAsPDF()">Sohbeti ƒ∞ndir (TXT)</button>
    <button class="btn" onclick="deleteAllMessages()">T√ºm Global Mesajlarƒ± Sil</button>
    <button class="btn" onclick="viewAllUsers()">T√ºm Kullanƒ±cƒ±larƒ± G√∂r√ºnt√ºle</button>
    <button class="btn" onclick="clearUserMessages()">Bir Kullanƒ±cƒ±nƒ±n Mesajlarƒ±nƒ± Sil</button>
    <button class="btn" onclick="kickUser()">Kullanƒ±cƒ±yƒ± Sunucudan At</button>
    <button class="btn danger-btn" onclick="closeAdminModal()">Kapat</button>
  </div>
</div>

<!-- Ban Listesi Popup -->
<div id="banListPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Ban Listesi</h2>
    <div id="bannedUsersList"></div>
    <button class="btn" onclick="closeBanList()">Kapat</button>
  </div>
</div>

<!-- Sessize Alma Popup -->
<div id="mutePopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Kullanƒ±cƒ±yƒ± Sessize Al</h2>
    <input type="text" id="muteUsername" placeholder="Kullanƒ±cƒ± adƒ±">
    <input type="number" id="muteDuration" placeholder="S√ºre (dakika)" min="1">
    <button class="btn" onclick="confirmMute()">Sessize Al</button>
    <button class="btn danger-btn" onclick="closeMutePopup()">Kapat</button>
    <div id="muteError" class="error"></div>
  </div>
</div>

<!-- Duyuru Listesi Popup -->
<div id="announcementListPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Duyurularƒ± Sil</h2>
    <div id="announcementList"></div>
    <button class="btn" onclick="closeAnnouncementList()">Kapat</button>
  </div>
</div>

<!-- Kullanƒ±cƒ± Bilgi Popup -->
<div id="userInfoPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Kullanƒ±cƒ± Bilgileri</h2>
    <div id="userInfoContent"></div>
    <button class="btn" onclick="closeUserInfoPopup()">Kapat</button>
  </div>
</div>

<!-- T√ºm Kullanƒ±cƒ±lar Popup (Admin) -->
<div id="allUsersPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>T√ºm Kullanƒ±cƒ±lar</h2>
    <div id="allUsersList" style="max-height:60vh; overflow-y:auto;"></div>
    <button class="btn" onclick="closeAllUsersPopup()">Kapat</button>
  </div>
</div>

<!-- Sohbet Ekranƒ± -->
<div id="chat">
  <!-- Kullanƒ±cƒ± Kontrolleri -->
  <div id="userControls">
    <button class="btn" onclick="toggleTheme()">Tema Deƒüi≈ütir</button>
    <button class="btn" onclick="openChangePasswordPopup()">≈ûifre Deƒüi≈ütir</button>
    <button class="btn" onclick="openChangeUsernamePopup()">Kullanƒ±cƒ± Adƒ± Deƒüi≈ütir</button>
    <button class="btn" onclick="openMyMessagesPopup()">Mesajlarƒ±m</button>
    <button class="btn" onclick="showStartChatModal()">Sohbete Ba≈üla</button>
    <button class="btn" onclick="logout()">Oturumu Kapat</button>
    <button id="toggleAdminBtn" class="btn danger-btn" style="display:none;" onclick="openAdminModal()">Admin Panel</button>
    <span id="onlineCount">√áevrimi√ßi: 0</span>
  </div>

  <!-- Typing Indicator -->
  <div id="typingIndicator">Kar≈üƒ± taraf yazƒ±yor...</div>

  <!-- Mesaj Arama -->
  <div style="padding:12px 16px; background:#292d31; border-bottom:1px solid #3a3f45;">
    <input type="text" id="searchInput" placeholder="Mesajlarda ara..." style="width:100%; padding:10px; border:none; border-radius:6px; background:#3b3f44; color:#e1e3e5; font-size:14px;" oninput="searchMessages()">
  </div>

  <!-- Mesajlar -->
  <div id="messages"></div>

  <!-- Mesaj G√∂nderme & Resim Y√ºkleme Alanƒ± -->
  <div id="inputArea">
    <input id="messageInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." autocomplete="off" oninput="notifyTyping()" />
    <button id="sendBtn" class="btn" onclick="send()">G√∂nder</button>
    <!-- Cloudinary ‚ÄúResim Y√ºkle‚Äù butonu -->
    <button id="upload_widget" class="btn" style="margin-left:8px;">üì∑ Resim Y√ºkle</button>
  </div>
</div>

<!-- Profil Popup -->
<div id="profilePopup"></div>

<!-- Ban Listesi Popup -->
<div id="banListPopup"></div>

<!-- Sessize Alma Popup -->
<div id="mutePopup"></div>

<!-- Duyuru Listesi Popup -->
<div id="announcementListPopup"></div>

<!-- Kullanƒ±cƒ± Bilgi Popup -->
<div id="userInfoPopup"></div>

<!-- T√ºm Kullanƒ±cƒ±lar Popup -->
<div id="allUsersPopup"></div>

<!-- DM Kutusu -->
<div id="privateChat"></div>

<!-- Sohbete Ba≈üla Modal -->
<div id="startChatModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Sohbete Ba≈üla</h2>
    <input type="text" id="startChatUsername" placeholder="Kullanƒ±cƒ± adƒ±">
    <button class="btn" onclick="confirmStartChat()">Ba≈ülat</button>
    <button class="btn danger-btn" onclick="closeStartChatModal()">ƒ∞ptal</button>
    <div id="startChatError" class="error"></div>
  </div>
</div>

<!-- Bildirim Sesi -->
<audio id="mentionSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1144-pristine.mp3" preload="auto"></audio>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // --- Firebase Konfig√ºrasyonu ---
  const firebaseConfig = {
    apiKey: "AIzaSyAWA4a9VSTPUKWe4Pqsc6U6O0hrdFGlOd0",
    authDomain: "openchat2.firebaseapp.com",
    databaseURL: "https://openchat2-default-rtdb.firebaseio.com",
    projectId: "openchat2",
    storageBucket: "openchat2.appspot.com",
    messagingSenderId: "1046412600695",
    appId: "1:1046412600695:web:28f6c20c997c7e6d3aed72",
    measurementId: "G-KE583G0DX7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  let username = "";
  let userRole = "Tester";       // Mevcut kullanƒ±cƒ±nƒ±n rol√º: Admin, Moderator, VIP, BETA-TESTER, Tester, Normal
  let displayName = "";          // G√∂r√ºnen adƒ±
  let lastDisplayChange = 0;     // Son ad deƒüi≈üim timestamp
  let reloadInitialized = false;
  let darkMode = false;
  let autoScroll = true;
  let typingTimeout;

  // --- LocalStorage‚Äôdan ‚ÄúrememberUser‚Äù varsa otomatik giri≈ü ---
  window.onload = () => {
    const rem = localStorage.getItem('rememberUser');
    if (rem) {
      db.ref("users/" + rem).once("value", snap => {
        if (snap.exists() && !snap.val().banned && !snap.val().kicked) {
          loginUser(rem);
        } else {
          localStorage.removeItem('rememberUser');
        }
      });
    }
    // Duyurularƒ± dinle
    db.ref("announcements").on("child_added", snapshot => {
      const data = snapshot.val();
      const key = snapshot.key;
      addAnnouncementToUI(key, data);
    });
    db.ref("announcements").on("child_removed", snapshot => {
      const key = snapshot.key;
      const elem = document.getElementById("ann-" + key);
      if (elem) elem.remove();
    });
    // √áevrimi√ßi kullanƒ±cƒ± sayƒ±sƒ±nƒ± dinle
    db.ref("users").on("value", snap => {
      const users = snap.val() || {};
      const onlineCount = Object.values(users).filter(u => u.online).length;
      const ocElem = document.getElementById("onlineCount");
      if (ocElem) ocElem.innerText = "√áevrimi√ßi: " + onlineCount;
    });
  };

  // --- Kullanƒ±cƒ± Durumunu ƒ∞zleme (√áevrimi√ßi/√áevrimdƒ±≈üƒ±) ---
  function setOnlineStatus(isOnline) {
    if (username) {
      db.ref('users/' + username).update({ online: isOnline });
    }
  }
  window.addEventListener('beforeunload', () => {
    setOnlineStatus(false);
  });

  // --- Kayƒ±t ---
  function register() {
    const user = document.getElementById("authUsername").value.trim();
    const pass = document.getElementById("authPassword").value.trim();
    if (!user || !pass) {
      showError("L√ºtfen t√ºm alanlarƒ± doldurun.");
      return;
    }
    db.ref("users/" + user).once("value", snapshot => {
      if (snapshot.exists()) {
        showError("Bu kullanƒ±cƒ± adƒ± zaten kullanƒ±lƒ±yor.");
      } else {
        const defaultAvatar = ""; // Profil resimleri kaldƒ±rƒ±ldƒ±
        const registerDate = Date.now();
        db.ref("users/" + user).set({
          password: pass,
          avatar: defaultAvatar,
          online: false,
          favorites: {},
          role: "Tester",      // Her yeni kullanƒ±cƒ± ‚ÄúTester‚Äù etiketiyle ba≈ülar
          displayName: user,   // G√∂r√ºnen ad, varsayƒ±lan olarak kullanƒ±cƒ± adƒ± ile aynƒ±
          lastDisplayChange: 0,// G√∂r√ºnen ad deƒüi≈üimi i√ßin timestamp
          banned: false,
          mutedUntil: 0,
          kicked: false,
          registerDate: registerDate,
          totalMessages: 0
        }, () => {
          if (document.getElementById('rememberMeLogin').checked) {
            localStorage.setItem('rememberUser', user);
          }
          loginUser(user);
        });
      }
    });
  }

  // --- Giri≈ü ---
  function login() {
    const user = document.getElementById("authUsername").value.trim();
    const pass = document.getElementById("authPassword").value.trim();
    if (!user || !pass) {
      showError("L√ºtfen t√ºm alanlarƒ± doldurun.");
      return;
    }
    db.ref("users/" + user).once("value", snapshot => {
      if (snapshot.exists() && snapshot.val().password === pass) {
        if (snapshot.val().banned) {
          alert("Hesabƒ±nƒ±z banlanmƒ±≈ü.");
          return;
        }
        if (snapshot.val().kicked) {
          alert("Hesabƒ±nƒ±z sunucudan atƒ±lmƒ±≈ü.");
          return;
        }
        if (document.getElementById('rememberMeLogin').checked) {
          localStorage.setItem('rememberUser', user);
        }
        loginUser(user);
      } else {
        showError("Ge√ßersiz kullanƒ±cƒ± adƒ± veya ≈üifre.");
      }
    });
  }

  function showError(msg) {
    const errElem = document.getElementById("authError");
    if (errElem) errElem.innerText = msg;
  }

  // --- Giri≈ü ƒ∞≈ülemi ---
  function loginUser(user) {
    username = user;
    // Kullanƒ±cƒ±nƒ±n Veri Tabanƒ±ndaki Kaydƒ±nƒ± Oku
    db.ref("users/" + username).once("value", s => {
      const d = s.val() || {};
      // Eƒüer DB'de role yoksa ve kullanƒ±cƒ± adƒ± "Admin" ise direkt Admin ata
      if (!d.role && username === "Admin") {
        userRole = "Admin";
      } else {
        userRole = d.role || "Tester";
      }
      displayName = d.displayName || username;
      lastDisplayChange = d.lastDisplayChange || 0;
    });

    document.getElementById("authModal").style.display = "none";
    document.getElementById("chat").style.display = "flex";

    // Kullanƒ±cƒ± Kontrollerini G√∂ster
    document.getElementById("userControls").style.display = "flex";
    // Eƒüer Admin ise Admin Panel Butonunu G√∂ster
    if (userRole === "Admin") {
      document.getElementById("toggleAdminBtn").style.display = "inline-block";
    }

    setOnlineStatus(true);

    // ƒ∞lk giri≈üse Ho≈ügeldiniz Popup'u
    if (!localStorage.getItem('welcomeShown')) {
      document.getElementById("welcomePopup").style.display = "flex";
      localStorage.setItem('welcomeShown', 'true');
    }

    loadMessages();
    listenForDeletesAndEdits();
    listenForReloadCommand();

    // Enter tu≈üuyla mesaj g√∂nderme ve typing indicator
    const msgInput = document.getElementById("messageInput");
    if (msgInput) {
      msgInput.addEventListener("keypress", (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          send();
        } else {
          notifyTyping();
        }
      });
    }
  }

  function closeWelcomePopup() {
    document.getElementById("welcomePopup").style.display = "none";
  }

  // --- Oturumu Kapat ---
  function logout() {
    setOnlineStatus(false);
    localStorage.removeItem('rememberUser');
    localStorage.removeItem('welcomeShown');
    username = "";
    location.reload();
  }

  // --- Mesaj G√∂nderme ---
  function send() {
    const msgElem = document.getElementById("messageInput");
    if (!msgElem) return;
    const msg = msgElem.value.trim();
    if (!msg) return;

    // Chat kilitli mi?
    db.ref("chatLock").once("value", snap => {
      if (snap.exists() && snap.val() === true && userRole !== "Admin") {
        alert("Sohbet kilitli; mesaj g√∂nderemezsiniz.");
        return;
      }
      // Sessize alƒ±ndƒ± mƒ±?
      db.ref("users/" + username + "/mutedUntil").once("value", mSnap => {
        const mutedUntil = mSnap.val() || 0;
        if (Date.now() < mutedUntil) {
          alert("Sessize alƒ±ndƒ±nƒ±z; mesaj g√∂nderemezsiniz.");
          return;
        }
        // K√ºf√ºr filtreleme
        const badWords = ["k√ºf√ºr1","k√ºf√ºr2"];
        let filtered = msg;
        badWords.forEach(w => {
          const rx = new RegExp(w, "gi");
          filtered = filtered.replace(rx, "***");
        });
        // Mesaj sayacƒ± arttƒ±r
        db.ref("users/" + username + "/totalMessages").transaction(n => (n || 0) + 1);

        const messageData = {
          username: username,
          message: filtered,
          imageURL: "",       // Bo≈üsa normal metin
          timestamp: Date.now()
        };
        db.ref("messages_global").push(messageData);
        msgElem.value = "";
      });
    });
  }

  // --- Mesajlarƒ± Y√ºkleme ve Dinleme ---
  function loadMessages() {
    const messagesDiv = document.getElementById("messages");
    if (!messagesDiv) return;
    messagesDiv.innerHTML = "";
    db.ref("messages_global").on("child_added", snapshot => {
      addOrUpdateMessage(snapshot.key, snapshot.val());
    });
  }

  function addOrUpdateMessage(key, val) {
    const messagesDiv = document.getElementById("messages");
    if (!messagesDiv) return;
    let msgDiv = document.getElementById("msg-" + key);

    if (!msgDiv) {
      msgDiv = document.createElement("div");
      msgDiv.className = "message";
      msgDiv.id = "msg-" + key;
      messagesDiv.appendChild(msgDiv);
    }

    // Yazarƒ± ve rol√ºn√º dinamik olarak al
    db.ref("users/" + val.username).once("value", snapUser => {
      const userData = snapUser.val() || {};
      // Kayƒ±t tarihi 0 ise ≈üu an olarak atama
      const regDateRaw = userData.registerDate || Date.now();
      const regDate = regDateRaw > 0 ? regDateRaw : Date.now();
      const now = Date.now();
      const daysSince = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));

      // Rol etiketleri: √ñncelik sƒ±rasƒ±: Admin > Moderator > VIP > BETA-TESTER > Tester > Normal
      let roleLabel = "";
      if (userData.role === "Admin") {
        roleLabel = `<span class="role-tag">ADMƒ∞N</span>`;
      } else if (userData.role === "Moderator") {
        roleLabel = `<span class="role-tag">MODERAT√ñR</span>`;
      } else if (userData.role === "VIP") {
        roleLabel = `<span class="role-tag">VIP</span>`;
      } else if (userData.role === "BETA-TESTER") {
        roleLabel = `<span class="role-tag">BETA-TESTER</span>`;
      } else if (userData.role === "Tester") {
        roleLabel = `<span class="role-tag">TESTER</span>`;
      } else {
        roleLabel = ""; // Normal kullanƒ±cƒ±
      }

      const dispName = userData.displayName || val.username;

      // <header> olu≈ütur
      const headerDiv = document.createElement("div");
      headerDiv.className = "header";

      const userSpan = document.createElement("span");
      userSpan.className = "author";
      userSpan.innerHTML = `${dispName} ${roleLabel}`;
      userSpan.onclick = (e) => showProfilePopup(val.username, e.pageX, e.pageY);

      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      const date = new Date(val.timestamp);
      timeSpan.innerText = date.toLocaleString("tr-TR", {
        hour: "2-digit",
        minute: "2-digit",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });

      headerDiv.appendChild(userSpan);
      headerDiv.appendChild(timeSpan);

      const contentDiv = document.createElement("div");
      contentDiv.className = "content";
      contentDiv.innerText = val.message;

      // Eƒüer bir resim URL‚Äôsi varsa, i√ßeriƒüin altƒ±na <img> ekle
      let imageElem = null;
      if (val.imageURL && val.imageURL !== "") {
        imageElem = document.createElement("img");
        imageElem.src = val.imageURL;
      }

      // Mention kontrol√º
      if (val.message.includes("@" + displayName)) {
        msgDiv.classList.add("mention");
        const sound = document.getElementById("mentionSound");
        if (sound) sound.play().catch(()=>{});
        showMentionPopup();
      } else {
        msgDiv.classList.remove("mention");
      }

      // Sil/D√ºzenle: Mesaj sahibi veya Admin ise
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "actions";
      if (val.username === username || userRole === "Admin") {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn delete-btn small";
        deleteBtn.innerText = "Sil";
        deleteBtn.onclick = () => db.ref("messages_global/" + key).remove();

        const editBtn = document.createElement("button");
        editBtn.className = "btn edit-btn small";
        editBtn.innerText = "D√ºzenle";
        editBtn.onclick = () => {
          const newMessage = prompt("Yeni mesajƒ± girin:", val.message);
          if (newMessage && newMessage.trim() !== "") {
            db.ref("messages_global/" + key).update({ message: newMessage.trim() });
          }
        };

        actionsDiv.appendChild(deleteBtn);
        actionsDiv.appendChild(editBtn);
      }

      msgDiv.innerHTML = "";
      msgDiv.appendChild(headerDiv);
      msgDiv.appendChild(contentDiv);
      if (imageElem) msgDiv.appendChild(imageElem);
      msgDiv.appendChild(actionsDiv);

      if (autoScroll) messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // --- Silme ve D√ºzenleme Dinleme ---
  function listenForDeletesAndEdits() {
    db.ref("messages_global").on("child_removed", snapshot => {
      const msgDiv = document.getElementById("msg-" + snapshot.key);
      if (msgDiv) msgDiv.remove();
    });
    db.ref("messages_global").on("child_changed", snapshot => {
      addOrUpdateMessage(snapshot.key, snapshot.val());
    });
  }

  // --- Admin: T√ºm Mesajlarƒ± Sil ---
  function deleteAllMessages() {
    if (confirm("Sohbetteki t√ºm mesajlarƒ± silmek istediƒüinizden emin misiniz?")) {
      db.ref("messages_global").remove();
    }
  }

  // --- Siteyi Yenile Komutu (Admin) ---
  function triggerReloadCommand() {
    db.ref("reload_commands").push({ timestamp: Date.now() });
  }
  function listenForReloadCommand() {
    const reloadRef = db.ref("reload_commands");
    reloadRef.once("value", () => { reloadInitialized = true; });
    reloadRef.on("child_added", snapshot => {
      if (reloadInitialized) {
        alert("Y√∂netici sayfayƒ± yeniledi, sayfa yeniden y√ºklenecek.");
        location.reload();
      }
    });
  }

  // --- Tema Deƒüi≈ütir ---
  function toggleTheme() {
    darkMode = !darkMode;
    if (darkMode) {
      document.body.classList.remove("light-mode");
    } else {
      document.body.classList.add("light-mode");
    }
  }

  // --- Admin Modal G√∂ster/Gizle ---
  function openAdminModal() {
    document.getElementById("adminModal").style.display = "flex";
  }
  function closeAdminModal() {
    document.getElementById("adminModal").style.display = "none";
  }

  // --- Profil Popup ---
  function showProfilePopup(user, x, y) {
    db.ref("users/" + user).once("value", snapUser => {
      const data = snapUser.val() || {};
      const popup = document.getElementById("profilePopup");

      // Ge√ßerli kayƒ±t tarihini belirle
      const regDateRaw = data.registerDate || Date.now();
      const regDate = regDateRaw > 0 ? regDateRaw : Date.now();
      const dateStr = new Date(regDate).toLocaleDateString("tr-TR");
      const daysSince = Math.floor((Date.now() - regDate) / (1000 * 60 * 60 * 24));

      // Rol etiketleri
      let roleLabel = "";
      if (data.role === "Admin") {
        roleLabel = `<span class="role-tag">ADMƒ∞N</span>`;
      } else if (data.role === "Moderator") {
        roleLabel = `<span class="role-tag">MODERAT√ñR</span>`;
      } else if (data.role === "VIP") {
        roleLabel = `<span class="role-tag">VIP</span>`;
      } else if (data.role === "BETA-TESTER") {
        roleLabel = `<span class="role-tag">BETA-TESTER</span>`;
      } else if (data.role === "Tester") {
        roleLabel = `<span class="role-tag">TESTER</span>`;
      } else {
        roleLabel = "";
      }

      const disp = data.displayName || user;
      popup.innerHTML = `
        <div class="username">${disp} ${roleLabel}</div>
        <div class="register-date">Kayƒ±t Tarihi: ${dateStr}</div>
        <div class="days-since">Kayƒ±tlƒ±: ${daysSince} g√ºn</div>
        <div class="status">${data.online ? "üü¢ Online" : "‚ö™ Offline"}</div>
        <button class="btn" onclick="startPrivateChat('${user}')">√ñzel Mesaj G√∂nder</button>
        <button class="btn danger-btn" onclick="closeProfilePopup()">Kapat</button>
      `;
      popup.style.left = x + "px";
      popup.style.top = y + "px";
      popup.style.display = "block";
      setTimeout(() => {
        document.addEventListener("click", hideProfilePopupOnce);
      }, 100);
    });
  }
  function hideProfilePopupOnce() {
    document.getElementById("profilePopup").style.display = "none";
    document.removeEventListener("click", hideProfilePopupOnce);
  }
  function closeProfilePopup() {
    document.getElementById("profilePopup").style.display = "none";
  }

  function sanitizeKey(key) {
    return key.replace(/[^a-zA-Z0-9_-]/g, '');
  }

  // --- √ñzel Mesajla≈üma (DM) ---
  function startPrivateChat(targetUser) {
    const threadKey = [sanitizeKey(username), sanitizeKey(targetUser)].sort().join("_");
    openPrivateChatWindow(targetUser, threadKey);
  }

  function openPrivateChatWindow(targetUser, threadKey) {
    document.getElementById("chat").style.display = "none";
    let privateDiv = document.getElementById("privateChat");

    const tpl = `
      <button class="btn startChatBtn" onclick="showStartChatModal()">Sohbete Ba≈üla</button>
      <div class="header">
        <span>√ñzel Sohbet: ${targetUser}</span>
        <button class="btn danger-btn small" onclick="closePrivateChat()">‚úñ ƒ∞ptal</button>
      </div>
      <div class="messages" id="privateMessages"></div>
      <div class="inputArea">
        <input id="privateInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." oninput="notifyTyping()" />
        <button class="btn" onclick="sendPrivateMessage('${threadKey}','${targetUser}')">G√∂nder</button>
      </div>
    `;
    if (!privateDiv) {
      privateDiv = document.createElement("div");
      privateDiv.id = "privateChat";
      privateDiv.style = "display:flex; flex-direction:column; height:100vh; background:#1e2124; color:#e1e3e5;";
      privateDiv.innerHTML = tpl;
      document.body.appendChild(privateDiv);
    } else {
      privateDiv.innerHTML = tpl;
      privateDiv.style.display = "flex";
    }

    const pmDiv = document.getElementById("privateMessages");
    pmDiv.innerHTML = "";
    db.ref(`private_messages/${threadKey}`).off();
    db.ref(`private_messages/${threadKey}`).on("child_added", snap => {
      const val = snap.val();
      const msgEl = document.createElement("div");
      msgEl.className = "msg";

      // √ñzel mesaj i√ßinde okundu durumu ve aksi i≈ülemleri
      let actionsHtml = "";
      if (val.username === username || userRole === "Admin") {
        actionsHtml = `
          <button class="btn delete-btn small" onclick="deletePrivateMessage('${threadKey}','${snap.key}')">Sil</button>
          <button class="btn edit-btn small" onclick="editPrivateMessage('${threadKey}','${snap.key}','${val.message}')">D√ºzenle</button>
        `;
      }

      const readMark = val.read ? '‚úì Okundu' : '‚úâ G√∂nderildi';

      msgEl.innerHTML = `
        <div class="header">
          <span>${val.username}</span>
          <span class="read-status">${readMark}</span>
        </div>
        <div class="content">${val.message}</div>
        <div class="actions">${actionsHtml}</div>
      `;
      pmDiv.appendChild(msgEl);
      pmDiv.scrollTop = pmDiv.scrollHeight;
      if (!val.read) {
        snap.ref.update({ read: true });
      }
    });
  }

  function deletePrivateMessage(threadKey, msgKey) {
    if (confirm("Bu √∂zel mesajƒ± silmek istediƒüinize emin misiniz?")) {
      db.ref(`private_messages/${threadKey}/${msgKey}`).remove();
    }
  }

  function editPrivateMessage(threadKey, msgKey, oldMsg) {
    const newMessage = prompt("Yeni mesajƒ± girin:", oldMsg);
    if (newMessage && newMessage.trim() !== "") {
      db.ref(`private_messages/${threadKey}/${msgKey}`).update({ message: newMessage.trim() });
    }
  }

  function confirmStartChat() {
    const inp = document.getElementById("startChatUsername");
    const err = document.getElementById("startChatError");
    if (!inp || !err) return;
    const other = inp.value.trim();
    if (!other) {
      err.innerText = "Kullanƒ±cƒ± adƒ± girin.";
      return;
    }
    if (other === username) {
      err.innerText = "Kendinizle DM g√∂nderemezsiniz.";
      return;
    }
    db.ref("users/" + other).once("value", snap => {
      if (snap.exists() && !snap.val().banned && !snap.val().kicked) {
        closeStartChatModal();
        startPrivateChat(other);
      } else {
        err.innerText = "Kullanƒ±cƒ± bulunamadƒ± veya engellenmi≈ü.";
      }
    });
  }

  function closeStartChatModal() {
    document.getElementById("startChatModal").style.display = "none";
    const inp = document.getElementById("startChatUsername");
    const err = document.getElementById("startChatError");
    if (inp) inp.value = "";
    if (err) err.innerText = "";
  }
  function showStartChatModal() {
    document.getElementById("startChatModal").style.display = "flex";
  }

  function sendPrivateMessage(threadKey, targetUser) {
    const input = document.getElementById("privateInput");
    if (!input) return;
    const msg = input.value.trim();
    if (!msg) return;
    db.ref("users/" + username + "/mutedUntil").once("value", mSnap => {
      const mutedUntil = mSnap.val() || 0;
      if (Date.now() < mutedUntil) {
        alert("Sessize alƒ±ndƒ±nƒ±z; DM g√∂nderemezsiniz.");
        return;
      }
      db.ref(`private_messages/${threadKey}`).push({
        username: username,
        message: msg,
        timestamp: Date.now(),
        read: false
      });
      input.value = "";
    });
  }

  function closePrivateChat() {
    const privateDiv = document.getElementById("privateChat");
    if (privateDiv) privateDiv.style.display = "none";
    document.getElementById("chat").style.display = "flex";
  }

  // --- Typing Indicator ---
  function notifyTyping() {
    const indicator = document.getElementById("typingIndicator");
    if (!indicator) return;
    indicator.style.display = "block";
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      indicator.style.display = "none";
    }, 1500);
  }

  // --- ≈ûifre Deƒüi≈ütir ---
  function openChangePasswordPopup() {
    document.getElementById("changePasswordPopup").style.display = "flex";
  }
  function closeChangePasswordPopup() {
    document.getElementById("changePasswordPopup").style.display = "none";
    const err = document.getElementById("changePassError");
    if (err) err.innerText = "";
    const oldP = document.getElementById("oldPassword");
    const newP = document.getElementById("newPassword");
    if (oldP) oldP.value = "";
    if (newP) newP.value = "";
  }
  function changePassword() {
    const oldPassElem = document.getElementById("oldPassword");
    const newPassElem = document.getElementById("newPassword");
    if (!oldPassElem || !newPassElem) return;
    const oldPass = oldPassElem.value.trim();
    const newPass = newPassElem.value.trim();
    if (!oldPass || !newPass) {
      const err = document.getElementById("changePassError");
      if (err) err.innerText = "L√ºtfen t√ºm alanlarƒ± doldurun.";
      return;
    }
    db.ref("users/" + username).once("value", snapshot => {
      if (snapshot.exists() && snapshot.val().password === oldPass) {
        db.ref("users/" + username).update({ password: newPass }, () => {
          alert("≈ûifreniz ba≈üarƒ±yla deƒüi≈ütirildi.");
          closeChangePasswordPopup();
        });
      } else {
        const err = document.getElementById("changePassError");
        if (err) err.innerText = "Eski ≈üifre hatalƒ±.";
      }
    });
  }

  // --- Kullanƒ±cƒ± Adƒ± (displayName) Deƒüi≈ütir ---
  function openChangeUsernamePopup() {
    document.getElementById("changeUsernamePopup").style.display = "flex";
    const err = document.getElementById("changeNameError");
    if (err) err.innerText = "";
    const inp = document.getElementById("newDisplayName");
    if (inp) inp.value = "";
  }
  function closeChangeUsernamePopup() {
    document.getElementById("changeUsernamePopup").style.display = "none";
  }
  function changeUsername() {
    const inp = document.getElementById("newDisplayName");
    const err = document.getElementById("changeNameError");
    if (!inp || !err) return;
    const newDisp = inp.value.trim();
    if (!newDisp) {
      err.innerText = "Yeni g√∂r√ºn√ºr ad bo≈ü olamaz.";
      return;
    }
    // 1 saat kƒ±sƒ±tlamasƒ±
    const now = Date.now();
    if (now - lastDisplayChange < 3600000) {
      const waitSec = Math.ceil((3600000 - (now - lastDisplayChange)) / 60000);
      err.innerText = `Yeni ad deƒüi≈üikliƒüi i√ßin ${waitSec} dakika bekleyin.`;
      return;
    }
    // Ba≈üka kullanƒ±cƒ±da aynƒ± displayName var mƒ± diye kontrol
    db.ref("users").once("value", snap => {
      const allUsers = snap.val() || {};
      for (let u in allUsers) {
        if (u !== username && allUsers[u].displayName === newDisp) {
          err.innerText = "Bu isim zaten kullanƒ±lƒ±yor.";
          return;
        }
      }
      // Eƒüer ge√ßtiyse, g√ºncelle
      db.ref("users/" + username).update({
        displayName: newDisp,
        lastDisplayChange: now
      }, () => {
        displayName = newDisp;
        lastDisplayChange = now;
        alert("G√∂r√ºn√ºr adƒ±nƒ±z ba≈üarƒ±yla deƒüi≈ütirildi.");
        closeChangeUsernamePopup();
        // Mesajlarƒ± yeniden y√ºkleyerek yeni adlarƒ± g√∂ster
        document.getElementById("messages").innerHTML = "";
        loadMessages();
      });
    });
  }

  // --- Mesajlarƒ±m Popup ---
  function openMyMessagesPopup() {
    document.getElementById("myMessagesPopup").style.display = "flex";
    loadMyMessages();
  }
  function closeMyMessagesPopup() {
    document.getElementById("myMessagesPopup").style.display = "none";
  }
  function loadMyMessages() {
    const container = document.getElementById("myMessagesContent");
    if (!container) return;
    container.innerHTML = "";
    db.ref("private_messages").once("value", snapshot => {
      if (!snapshot.exists()) {
        container.innerHTML = "<p>Hen√ºz √∂zel mesajƒ±nƒ±z yok.</p>";
        return;
      }
      const threads = snapshot.val();
      const myKey = sanitizeKey(username);
      let foundAny = false;
      Object.keys(threads).forEach(threadKey => {
        if (threadKey.includes(myKey)) {
          foundAny = true;
          const parts = threadKey.split("_");
          const other = parts[0] === myKey ? parts[1] : parts[0];
          const threadDiv = document.createElement("div");
          threadDiv.className = "thread";
          const unreadCount = Object.values(threads[threadKey]).filter(m => !m.read && m.username !== username).length;
          threadDiv.innerHTML = `
            <span>${other} ile sohbet</span>
            ${unreadCount ? `<span class="badge">${unreadCount}</span>` : ""}
          `;
          threadDiv.onclick = () => {
            closeMyMessagesPopup();
            openPrivateChatWindow(other, threadKey);
          };
          container.appendChild(threadDiv);
        }
      });
      if (!foundAny) {
        container.innerHTML = "<p>Hen√ºz √∂zel mesajƒ±nƒ±z yok.</p>";
      }
    });
  }

  // --- Mesaj Arama ---
  function searchMessages() {
    const queryElem = document.getElementById("searchInput");
    if (!queryElem) return;
    const query = queryElem.value.toLowerCase();
    const msgs = document.querySelectorAll("#messages .message");
    msgs.forEach(msg => {
      const contentElem = msg.querySelector(".content");
      const text = contentElem ? contentElem.innerText.toLowerCase() : "";
      msg.style.display = text.includes(query) ? "block" : "none";
    });
  }

  // --- Mention Popup G√∂ster/Gizle ---
  function showMentionPopup() {
    const popup = document.getElementById("mentionPopup");
    if (!popup) return;
    popup.style.display = "block";
    setTimeout(() => {
      popup.style.display = "none";
    }, 3000);
  }

  // --- Admin ƒ∞≈ülevleri ---
  // Ban Listesi
  function openBanList() {
    const popup = document.getElementById("banListPopup");
    const listDiv = document.getElementById("bannedUsersList");
    if (!popup || !listDiv) return;
    listDiv.innerHTML = "";
    db.ref("users").once("value", snap => {
      const users = snap.val() || {};
      Object.keys(users).forEach(u => {
        if (users[u].banned) {
          const item = document.createElement("div");
          item.className = "user-item";
          item.innerHTML = `<span>${u}</span><button class="btn small" onclick="unbanUser('${u}')">Ban Kaldƒ±r</button>`;
          listDiv.appendChild(item);
        }
      });
      if (listDiv.innerHTML === "") {
        listDiv.innerHTML = "<p>Banlƒ± kullanƒ±cƒ± yok.</p>";
      }
      popup.style.display = "flex";
    });
  }
  function closeBanList() {
    const popup = document.getElementById("banListPopup");
    if (popup) popup.style.display = "none";
  }
  function unbanUser(u) {
    db.ref("users/" + u).update({ banned: false });
    openBanList();
  }

  // Sessize Alma
  function openMutePopup() {
    const errElem = document.getElementById("muteError");
    if (errElem) errElem.innerText = "";
    const uElem = document.getElementById("muteUsername");
    const dElem = document.getElementById("muteDuration");
    if (uElem) uElem.value = "";
    if (dElem) dElem.value = "";
    const popup = document.getElementById("mutePopup");
    if (popup) popup.style.display = "flex";
  }
  function closeMutePopup() {
    const popup = document.getElementById("mutePopup");
    if (popup) popup.style.display = "none";
  }
  function confirmMute() {
    const uElem = document.getElementById("muteUsername");
    const dElem = document.getElementById("muteDuration");
    const errElem = document.getElementById("muteError");
    if (!uElem || !dElem || !errElem) return;
    const u = uElem.value.trim();
    const dur = parseInt(dElem.value);
    if (!u || !dur || dur <= 0) {
      errElem.innerText = "Ge√ßerli deƒüer girin.";
      return;
    }
    db.ref("users/" + u).once("value", snap => {
      if (snap.exists()) {
        const until = Date.now() + dur * 60000;
        db.ref("users/" + u).update({ mutedUntil: until });
        alert(`${u} ${dur} dakika boyunca sessize alƒ±ndƒ±.`);
        closeMutePopup();
      } else {
        errElem.innerText = "Kullanƒ±cƒ± bulunamadƒ±.";
      }
    });
  }

  // Kullanƒ±cƒ± Bilgisi G√∂r√ºnt√ºle
  function openUserInfo() {
    const target = prompt("Bilgilerini g√∂r√ºnt√ºlemek istediƒüiniz kullanƒ±cƒ± adƒ±:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        const data = snap.val();
        const content = document.getElementById("userInfoContent");
        if (!content) return;
        // Ge√ßerli kayƒ±t tarihi
        const regDateRaw = data.registerDate || Date.now();
        const regDate = regDateRaw > 0 ? regDateRaw : Date.now();
        const dateStr = new Date(regDate).toLocaleString("tr-TR", {
          day: "2-digit", month: "2-digit", year: "numeric",
          hour: "2-digit", minute: "2-digit"
        });
        const daysSince = Math.floor((Date.now() - regDate) / (1000 * 60 * 60 * 24));
        let roleLabel = "";
        if (data.role === "Admin") {
          roleLabel = `<p><strong>Rol:</strong> ADMƒ∞N</p>`;
        } else if (data.role === "Moderator") {
          roleLabel = `<p><strong>Rol:</strong> MODERAT√ñR</p>`;
        } else if (data.role === "VIP") {
          roleLabel = `<p><strong>Rol:</strong> VIP</p>`;
        } else if (data.role === "BETA-TESTER") {
          roleLabel = `<p><strong>Rol:</strong> BETA-TESTER</p>`;
        } else if (data.role === "Tester") {
          roleLabel = `<p><strong>Rol:</strong> TESTER</p>`;
        } else {
          roleLabel = `<p><strong>Rol:</strong> Normal</p>`;
        }
        const disp = data.displayName || target;
        content.innerHTML = `
          <p><strong>Kullanƒ±cƒ±:</strong> ${disp}</p>
          <p><strong>Kayƒ±t Tarihi:</strong> ${dateStr}</p>
          <p><strong>Kayƒ±tlƒ±:</strong> ${daysSince} g√ºn √∂nce</p>
          <p><strong>√áevrimi√ßi:</strong> ${data.online ? 'Evet' : 'Hayƒ±r'}</p>
          <p><strong>Toplam Mesaj:</strong> ${data.totalMessages || 0}</p>
          <p><strong>Banlƒ±:</strong> ${data.banned ? 'Evet' : 'Hayƒ±r'}</p>
          <p><strong>Sessize Alƒ±ndƒ± mƒ±:</strong> ${Date.now() < (data.mutedUntil || 0) ? 'Evet' : 'Hayƒ±r'}</p>
          ${roleLabel}
        `;
        document.getElementById("userInfoPopup").style.display = "flex";
      } else {
        alert("Kullanƒ±cƒ± bulunamadƒ±.");
      }
    });
  }
  function closeUserInfoPopup() {
    const popup = document.getElementById("userInfoPopup");
    if (popup) popup.style.display = "none";
  }

  // Banla (tek kullanƒ±cƒ±)
  function banUser() {
    const target = prompt("Banlanacak kullanƒ±cƒ± adƒ±:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        db.ref("users/" + target).update({ banned: true });
        alert("Kullanƒ±cƒ± banlandƒ±.");
      } else {
        alert("Kullanƒ±cƒ± bulunamadƒ±.");
      }
    });
  }

  // Sohbet Kilitle
  function lockChat() {
    db.ref("chatLock").once("value", snap => {
      if (snap.exists() && snap.val() === true) {
        db.ref("chatLock").set(false);
        alert("Sohbet kilidi kaldƒ±rƒ±ldƒ±.");
      } else {
        db.ref("chatLock").set(true);
        alert("Sohbet kilitlendi.");
      }
    });
  }

  // Duyuru G√∂nder
  function announce() {
    const ann = prompt("Duyuru mesajƒ±:");
    if (!ann) return;
    db.ref("announcements").push({ message: ann, timestamp: Date.now() });
    alert("Duyuru g√∂nderildi.");
  }

  // Admin duyurularƒ± silmek i√ßin listeyi getir
  function openAnnouncementList() {
    const popup = document.getElementById("announcementListPopup");
    const listDiv = document.getElementById("announcementList");
    if (!popup || !listDiv) return;
    listDiv.innerHTML = "";
    db.ref("announcements").once("value", snap => {
      const anns = snap.val() || {};
      Object.keys(anns).forEach(key => {
        const ann = anns[key];
        const item = document.createElement("div");
        item.className = "announcement-item";
        item.innerHTML = `
          <p>${new Date(ann.timestamp).toLocaleDateString("tr-TR", {
            hour: "2-digit", minute: "2-digit",
            day: "2-digit", month: "2-digit", year: "numeric"
          })} - ${ann.message}</p>
          <button class="btn small" onclick="deleteAnnouncement('${key}')">Sil</button>
        `;
        listDiv.appendChild(item);
      });
      if (listDiv.innerHTML === "") {
        listDiv.innerHTML = "<p>Hi√ß duyuru yok.</p>";
      }
      popup.style.display = "flex";
    });
  }
  function closeAnnouncementList() {
    const popup = document.getElementById("announcementListPopup");
    if (popup) popup.style.display = "none";
  }
  function deleteAnnouncement(key) {
    db.ref("announcements/" + key).remove();
  }

  // Admin Rolleri Ver
  function grantRole() {
    const target = prompt("Rol verilecek kullanƒ±cƒ± adƒ±:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (!snap.exists()) {
        alert("Kullanƒ±cƒ± bulunamadƒ±.");
        return;
      }
      const rol = prompt("Yeni rol (Normal, Tester, VIP, Moderator, Admin, BETA-TESTER) olarak girin:").trim();
      if (!rol || !["Normal","Tester","VIP","Moderator","Admin","BETA-TESTER"].includes(rol)) {
        alert("Ge√ßerli bir rol girin.");
        return;
      }
      db.ref("users/" + target).update({ role: rol }, () => {
        alert(`${target} kullanƒ±cƒ±sƒ±na ${rol} rol√º verildi.`);
      });
    });
  }

  // Aktif Kullanƒ±cƒ± Sayƒ±sƒ±
  function viewChatCount() {
    db.ref("users").once("value", snap => {
      const users = snap.val() || {};
      const onlineCount = Object.values(users).filter(u => u.online).length;
      alert("√áevrimi√ßi kullanƒ±cƒ± sayƒ±sƒ±: " + onlineCount);
    });
  }

  // DM Oku/D√ºzenle/Sil (basit listeleme)
  function viewDMAdmin() {
    db.ref("private_messages").once("value", snap => {
      if (!snap.exists()) {
        alert("Hi√ß DM yok.");
        return;
      }
      let list = "";
      snap.forEach(threadSnap => {
        const threadKey = threadSnap.key;
        threadSnap.forEach(msgSnap => {
          const d = msgSnap.val();
          list += `${threadKey} ‚Üí ${d.username}: ${d.message}\n`;
        });
      });
      alert("T√ºm DM‚Äôler:\n\n" + list);
    });
  }

  // Admin ≈ûifre Deƒüi≈ütir (DB √ºzerinden)
  function adminChangePassword() {
    const target = prompt("≈ûifresi deƒüi≈ütirilecek kullanƒ±cƒ± adƒ±:");
    const newPass = prompt("Yeni ≈üifre:");
    if (!target || !newPass) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        db.ref("users/" + target).update({ password: newPass });
        alert("Kullanƒ±cƒ±nƒ±n ≈üifresi g√ºncellendi.");
      } else {
        alert("Kullanƒ±cƒ± bulunamadƒ±.");
      }
    });
  }

  // Hesabƒ±na Gir (impersonate)
  function impersonate() {
    const target = prompt("Hesabƒ±na girilecek kullanƒ±cƒ± adƒ±:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists() && !snap.val().banned && !snap.val().kicked) {
        localStorage.setItem('rememberUser', target);
        loginUser(target);
      } else {
        alert("Kullanƒ±cƒ± bulunamadƒ± veya engellenmi≈ü.");
      }
    });
  }

  // Sohbeti ƒ∞ndir (PDF): basit metin formatƒ±nda indirme. PDF kitaplƒ±ƒüƒ± olmadan .txt olarak indiriyoruz.
  function downloadChatAsPDF() {
    db.ref("messages_global").once("value", snap => {
      const msgs = snap.val() || {};
      let content = "OpenChat Sohbet ƒ∞ndirimi\n\n";
      const entries = Object.entries(msgs);
      entries.sort((a,b) => a[1].timestamp - b[1].timestamp);
      entries.forEach(([key, m]) => {
        const dateStr = new Date(m.timestamp).toLocaleString("tr-TR");
        content += `${dateStr} | ${m.username}: ${m.message}\n`;
      });
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "OpenChat_Sohbet.txt"; // .txt olarak kaydediyoruz
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  // T√ºm Kullanƒ±cƒ± Listesi G√∂r√ºnt√ºleme (Admin)
  function viewAllUsers() {
    const popup = document.getElementById("allUsersPopup");
    const listDiv = document.getElementById("allUsersList");
    if (!popup || !listDiv) return;
    listDiv.innerHTML = "";
    db.ref("users").once("value", snap => {
      const users = snap.val() || {};
      Object.keys(users).forEach(u => {
        const d = users[u];
        // Kayƒ±t tarihi
        const regDateRaw = d.registerDate || Date.now();
        const regDate = regDateRaw > 0 ? regDateRaw : Date.now();
        const dateStr = new Date(regDate).toLocaleDateString("tr-TR");
        // Rol
        let roleLabel = "Normal";
        if (d.role === "Admin") {
          roleLabel = "ADMƒ∞N";
        } else if (d.role === "Moderator") {
          roleLabel = "MODERAT√ñR";
        } else if (d.role === "VIP") {
          roleLabel = "VIP";
        } else if (d.role === "BETA-TESTER") {
          roleLabel = "BETA-TESTER";
        } else if (d.role === "Tester") {
          roleLabel = "TESTER";
        }
        const item = document.createElement("div");
        item.style = "padding:8px; background:#2f3438; margin-bottom:4px; border-radius:4px; font-size:13px; color:#e1e3e5;";
        item.innerHTML = `
          <p><strong>${u}</strong> (${roleLabel})</p>
          <p style="font-size:12px; color:#9aa0a6;">Kayƒ±t: ${dateStr} | Toplam Mesaj: ${d.totalMessages || 0}</p>
        `;
        listDiv.appendChild(item);
      });
      if (listDiv.innerHTML === "") {
        listDiv.innerHTML = "<p>Hi√ß kullanƒ±cƒ± yok.</p>";
      }
      popup.style.display = "flex";
    });
  }
  function closeAllUsersPopup() {
    const popup = document.getElementById("allUsersPopup");
    if (popup) popup.style.display = "none";
  }

  // Bir Kullanƒ±cƒ±nƒ±n Global Mesajlarƒ±nƒ± Sil (Admin)
  function clearUserMessages() {
    const target = prompt("Mesajlarƒ± silinecek kullanƒ±cƒ± adƒ±:");
    if (!target) return;
    if (!confirm(`${target} kullanƒ±cƒ±sƒ±nƒ±n t√ºm global mesajlarƒ± silinsin mi?`)) return;
    db.ref("messages_global").once("value", snap => {
      snap.forEach(child => {
        const m = child.val();
        if (m.username === target) {
          db.ref("messages_global/" + child.key).remove();
        }
      });
      alert(`${target} kullanƒ±cƒ±sƒ±nƒ±n t√ºm mesajlarƒ± silindi.`);
    });
  }

  // Admin Kullanƒ±cƒ±yƒ± Sunucudan At (Kick)
  function kickUser() {
    const target = prompt("Sunucudan atƒ±lacak kullanƒ±cƒ± adƒ±:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (!snap.exists()) {
        alert("Kullanƒ±cƒ± bulunamadƒ±.");
        return;
      }
      db.ref("users/" + target).update({ kicked: true }, () => {
        alert(`${target} sunucudan atƒ±ldƒ±.`);
      });
    });
  }

  // Kullanƒ±cƒ± a√ßƒ±lƒ±≈üta ‚Äúkicked‚Äù ise oturumu kapat
  function checkIfKicked() {
    if (!username) return;
    db.ref("users/" + username + "/kicked").once("value", snap => {
      if (snap.exists() && snap.val() === true) {
        alert("Sunucudan atƒ±ldƒ±nƒ±z.");
        logout();
      }
    });
  }

  // Yardƒ±mcƒ±: Ekrana duyuru ekleme (UI)
  function addAnnouncementToUI(key, data) {
    const messagesDiv = document.getElementById("messages");
    if (!messagesDiv) return;
    const annDiv = document.createElement("div");
    annDiv.className = "message";
    annDiv.id = "ann-" + key;
    annDiv.innerHTML = `
      <div class="header">
        <span style="color:#faa61a">[DUYURU]</span>
        <span class="time">${new Date(data.timestamp).toLocaleDateString("tr-TR", {
          hour: "2-digit", minute: "2-digit",
          day: "2-digit", month: "2-digit", year: "numeric"
        })}</span>
        ${ userRole === "Admin" 
            ? `<button class="btn small danger-btn" onclick="deleteAnnouncement('${key}')">Sil</button>` 
            : "" }
      </div>
      <div class="content">${data.message}</div>
    `;
    messagesDiv.prepend(annDiv);
  }

  // --- Cloudinary ile Dosya Y√ºkleme --- 
  // 1) Cloud name ve upload preset‚Äôinizi a≈üaƒüƒ±ya yazƒ±n:
  const CLOUDINARY_CLOUD_NAME = "dane3zz3e";
  const CLOUDINARY_UPLOAD_PRESET = "OpenChat";

  // Cloudinary Widget Olu≈üturma (sayfanƒ±n y√ºklenmesiyle birlikte)
  var myWidget = cloudinary.createUploadWidget({
    cloudName: CLOUDINARY_CLOUD_NAME,
    uploadPreset: CLOUDINARY_UPLOAD_PRESET
  }, (error, result) => {
    if (!error && result && result.event === "success") {
      // Resim y√ºklendi: Firebase‚Äôe push et
      const imageURL = result.info.secure_url;
      const messageData = {
        username: username,
        message: "[RESƒ∞M]",
        imageURL: imageURL,
        timestamp: Date.now()
      };
      db.ref("messages_global").push(messageData);
    }
  });

  // ‚ÄúResim Y√ºkle‚Äù butonuna tƒ±klanƒ±nca widget‚Äôƒ± a√ß
  document.addEventListener('DOMContentLoaded', () => {
    const uploadBtn = document.getElementById("upload_widget");
    if (uploadBtn) {
      uploadBtn.addEventListener("click", function(){
        myWidget.open();
      }, false);
    }
  });

</script>

</body>
</html>
