<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenChat - Modern Arayüz</title>
  <style>
    /* --- Genel Ayarlar --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1e2124;
      color: #e1e3e5;
    }
    button, input {
      outline: none;
      font-family: inherit;
    }
    /* --- Modal Arka Plan --- */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .modal {
      background: #2f3438;
      border-radius: 8px;
      padding: 20px 30px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      text-align: center;
    }
    .modal h2 {
      margin-bottom: 15px;
      font-size: 22px;
      color: #ffffff;
    }
    .modal input, .modal select {
      width: 100%;
      margin: 8px 0;
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 14px;
    }
    .modal button {
      width: 100%;
      margin: 8px 0;
      padding: 8px 10px;
      border: none;
      border-radius: 6px;
      background-color: #4f86f7;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal button:hover {
      background-color: #3e6edc;
    }
    .modal .danger-btn {
      background-color: #e54b4b;
    }
    .modal .danger-btn:hover {
      background-color: #c43f3f;
    }
    .modal .error {
      margin-top: 8px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Sohbet Ekranı --- */
    #chat {
      display: none; /* Giriş sonrası JS ile 'flex' yapılıyor */
      height: 100%;
      display: flex;
      flex-direction: column;
      background: #1e2124;
    }
    #userControls {
      background: #292d31;
      padding: 8px 12px;
      display: none;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #3a3f45;
    }
    #userControls button {
      padding: 4px 8px;
      background-color: #4f86f7;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #userControls button:hover {
      background-color: #3e6edc;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #1e2124;
    }
    .message {
      background: #2f3438;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      position: relative;
      word-wrap: break-word;
    }
    .message .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .message .header .author {
      color: #4f86f7;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }
    .message .header .time {
      font-size: 10px;
      color: #9aa0a6;
    }
    .message .content {
      margin-top: 4px;
      font-size: 13px;
      line-height: 1.4;
      color: #e1e3e5;
    }
    .message.mention .content {
      color: #faa61a;
      font-weight: 600;
    }
    .message .actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    .message .actions button {
      font-size: 11px;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    .message .actions .delete-btn {
      background: #e54b4b;
    }
    .message .actions .delete-btn:hover {
      background: #c43f3f;
    }
    .message .actions .edit-btn {
      background: #4f86f7;
    }
    .message .actions .edit-btn:hover {
      background: #3e6edc;
    }
    .message.mention {
      background: #3b3f44;
    }

    #inputArea {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background-color: #2b2f33;
      border-top: 1px solid #3a3f45;
    }
    #messageInput {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 13px;
    }
    #sendBtn {
      margin-left: 8px;
      padding: 8px 12px;
      background-color: #4f86f7;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendBtn:hover {
      background-color: #3e6edc;
    }

    /* --- Profil Popup --- */
    #profilePopup {
      position: fixed;
      background-color: #292d31;
      color: #fff;
      border: 1px solid #3a3f45;
      border-radius: 8px;
      padding: 12px;
      display: none;
      z-index: 20;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #profilePopup .username {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    #profilePopup .status {
      text-align: center;
      font-size: 12px;
      color: #9aa0a6;
      margin-bottom: 8px;
    }
    #profilePopup button {
      display: block;
      width: 100%;
      margin-top: 6px;
      padding: 6px 8px;
      background-color: #4f86f7;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #profilePopup button:hover {
      background-color: #3e6edc;
    }

    /* --- Şifre Değiştir Popup --- */
    #changePasswordPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #changePasswordPopup .modal {
      width: 90%;
      max-width: 360px;
      text-align: center;
    }
    #changePasswordPopup input {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 14px;
    }
    #changePasswordPopup button {
      width: 100%;
      margin: 8px 0;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      background-color: #43b581;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #changePasswordPopup button:hover {
      background-color: #369c67;
    }
    #changePasswordPopup .danger-btn {
      background-color: #e54b4b;
    }
    #changePasswordPopup .danger-btn:hover {
      background-color: #c43f3f;
    }
    #changePasswordPopup .error {
      margin-top: 8px;
      color: #f15b5b;
      font-size: 13px;
    }

    /* --- Mesajlarım Popup --- */
    #myMessagesPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #myMessagesPopup .modal {
      width: 90%;
      max-width: 400px;
    }
    #myMessagesContent {
      background: #2f3438;
      border-radius: 8px;
      max-height: 70vh;
      overflow-y: auto;
      margin-top: 12px;
      padding: 10px;
    }
    #myMessagesContent .thread {
      padding: 10px;
      border-bottom: 1px solid #3a3f45;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
      font-size: 13px;
    }
    #myMessagesContent .thread:hover {
      background: #3b3f44;
    }
    #myMessagesContent .thread:last-child {
      border-bottom: none;
    }
    #myMessagesContent .thread .badge {
      background: #4f86f7;
      border-radius: 12px;
      color: #fff;
      padding: 2px 6px;
      font-size: 11px;
    }

    /* --- DM Kutusu (sayfa açılır açılmaz gizli) --- */
    #privateChat {
      display: none;
      flex-direction: column;
      height: 100vh;
      background: #1e2124;
      color: #e1e3e5;
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      z-index: 30;
    }
    #privateChat .startChatBtn {
      margin: 8px 12px;
      padding: 6px 10px;
      background-color: #4f86f7;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      align-self: flex-start;
    }
    #privateChat .startChatBtn:hover {
      background-color: #3e6edc;
    }
    #privateChat .header {
      background: #292d31;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #3a3f45;
    }
    #privateChat .header span {
      font-weight: 600;
      font-size: 14px;
      color: #4f86f7;
    }
    #privateChat .header button {
      background: #e54b4b;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #privateChat .header button:hover {
      background-color: #c43f3f;
    }
    #privateChat .messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #1e2124;
    }
    #privateChat .messages .msg {
      background: #2f3438;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      word-wrap: break-word;
    }
    #privateChat .messages .msg .header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #9aa0a6;
    }
    #privateChat .messages .msg .content {
      margin-top: 4px;
      font-size: 13px;
      color: #e1e3e5;
    }
    #privateChat .messages .msg .read-status {
      font-size: 0.8em;
      color: green;
      margin-left: 5px;
    }
    #privateChat .inputArea {
      display: flex;
      padding: 8px 12px;
      background: #2b2f33;
      border-top: 1px solid #3a3f45;
    }
    #privateChat .inputArea input {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      background: #3b3f44;
      color: #e1e3e5;
      font-size: 13px;
    }
    #privateChat .inputArea button {
      margin-left: 8px;
      padding: 8px 12px;
      background-color: #4f86f7;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #privateChat .inputArea button:hover {
      background-color: #3e6edc;
    }

    /* --- Mobil (max-width: 600px) --- */
    @media (max-width: 600px) {
      #userControls {
        flex-wrap: wrap;
        gap: 6px;
      }
      #inputArea, #privateChat .inputArea {
        flex-direction: column;
      }
      #sendBtn, #privateChat .inputArea button {
        margin-left: 0;
        margin-top: 8px;
      }
      #messageInput, #privateChat .inputArea input {
        font-size: 13px;
      }
      .message {
        font-size: 13px;
      }
      #authModal input {
        font-size: 13px;
      }
      #authModal button {
        font-size: 12px;
        padding: 6px 8px;
      }
      #changePasswordPopup input {
        font-size: 13px;
      }
      #changePasswordPopup button {
        font-size: 12px;
      }
      #myMessagesContent {
        width: 95%;
      }
      #myMessagesContent .thread {
        font-size: 13px;
        padding: 8px;
      }
      #privateChat .header, #privateChat .inputArea {
        padding: 8px 10px;
      }
      #privateChat .inputArea button {
        padding: 6px 8px;
        font-size: 13px;
      }
      #privateChat .inputArea input {
        font-size: 13px;
        padding: 6px 8px;
      }
    }

    /* --- Mention Popup --- */
    #mentionPopup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4f86f7;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: none;
      z-index: 50;
      font-size: 13px;
    }
  </style>
</head>
<body>

<!-- Mention Popup -->
<div id="mentionPopup">Birisi seni etiketledi!</div>

<!-- Kayıt/Giriş Modalı -->
<div id="authModal" class="modal-overlay">
  <div class="modal">
    <h2>OpenChat - Kayıt ve Giriş</h2>
    <input type="text" id="authUsername" placeholder="Kullanıcı adı">
    <input type="password" id="authPassword" placeholder="Şifre">
    <label>
      <input type="checkbox" id="rememberMeLogin"> Beni hatırla
    </label>
    <button onclick="register()">Kayıt Ol</button>
    <button onclick="login()">Giriş Yap</button>
    <div id="authError" class="error"></div>
  </div>
</div>

<!-- Şifre Değiştir Popup -->
<div id="changePasswordPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Şifre Değiştir</h2>
    <input type="password" id="oldPassword" placeholder="Eski Şifre">
    <input type="password" id="newPassword" placeholder="Yeni Şifre">
    <button onclick="changePassword()">Kaydet</button>
    <button class="danger-btn" onclick="closeChangePasswordPopup()">Kapat</button>
    <div id="changePassError" class="error"></div>
  </div>
</div>

<!-- Mesajlarım Popup -->
<div id="myMessagesPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Özel Mesajlarım</h2>
    <div id="myMessagesContent"></div>
    <button onclick="closeMyMessagesPopup()">Kapat</button>
  </div>
</div>

<!-- Admin Panel Modal -->
<div id="adminModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Admin Paneli</h2>
    <button onclick="openBanList()">Ban Listesi</button>
    <button onclick="openMutePopup()">Sessize Al</button>
    <button onclick="lockChat()">Sohbet Kilitle</button>
    <button onclick="announce()">Duyuru Gönder</button>
    <button onclick="grantAdmin()">Admin Yetkisi Ver</button>
    <button onclick="viewChatCount()">Aktif Kullanıcı Sayısı</button>
    <button onclick="openUserInfo()">Kullanıcı Bilgisi Görüntüle</button>
    <button onclick="viewDMAdmin()">DM Oku/Düzenle/Sil</button>
    <button onclick="adminChangePassword()">Şifre Değiştir</button>
    <button onclick="impersonate()">Hesabına Gir</button>
    <button onclick="deleteAllMessages()">Tüm Mesajları Sil</button>
    <button class="danger-btn" onclick="closeAdminModal()">Kapat</button>
  </div>
</div>

<!-- Sohbet Ekranı -->
<div id="chat">
  <!-- Kullanıcı Kontrolleri -->
  <div id="userControls">
    <button onclick="toggleTheme()">Tema Değiştir</button>
    <button onclick="openChangePasswordPopup()">Şifre Değiştir</button>
    <button onclick="openMyMessagesPopup()">Mesajlarım</button>
    <button onclick="promptNewChat()">Sohbete Başla</button>
    <button onclick="logout()">Oturumu Kapat</button>
    <button id="toggleAdminBtn" style="display:none;" onclick="openAdminModal()">Admin Panel</button>
  </div>

  <!-- Mesaj Arama -->
  <div style="padding:12px 16px; background:#292d31; border-bottom:1px solid #3a3f45;">
    <input type="text" id="searchInput" placeholder="Mesajlarda ara..." style="width:100%; padding:10px; border:none; border-radius:6px; background:#3b3f44; color:#e1e3e5; font-size:14px;" oninput="searchMessages()">
  </div>

  <!-- Mesajlar -->
  <div id="messages"></div>

  <!-- Mesaj Gönderme Alanı -->
  <div id="inputArea">
    <input id="messageInput" placeholder="Mesajınızı yazın..." autocomplete="off" />
    <button id="sendBtn" onclick="send()">Gönder</button>
  </div>
</div>

<!-- Profil Popup -->
<div id="profilePopup"></div>

<!-- Ban Listesi Popup -->
<div id="banListPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Ban Listesi</h2>
    <div id="bannedUsersList"></div>
    <button onclick="closeBanList()">Kapat</button>
  </div>
</div>

<!-- Sessize Alma Popup -->
<div id="mutePopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Kullanıcıyı Sessize Al</h2>
    <input type="text" id="muteUsername" placeholder="Kullanıcı adı">
    <input type="number" id="muteDuration" placeholder="Süre (dakika)" min="1">
    <button onclick="confirmMute()">Sessize Al</button>
    <button class="danger-btn" onclick="closeMutePopup()">Kapat</button>
    <div id="muteError" class="error"></div>
  </div>
</div>

<!-- Kullanıcı Bilgi Popup -->
<div id="userInfoPopup" class="modal-overlay" style="display:none;">
  <div class="modal">
    <h2>Kullanıcı Bilgileri</h2>
    <div id="userInfoContent"></div>
    <button onclick="closeUserInfoPopup()">Kapat</button>
  </div>
</div>

<!-- DM Kutusu -->
<div id="privateChat"></div>

<!-- Bildirim Sesi -->
<audio id="mentionSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1144-pristine.mp3" preload="auto"></audio>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // --- Firebase Konfigürasyonu ---
  const firebaseConfig = {
    apiKey: "AIzaSyAWA4a9VSTPUKWe4Pqsc6U6O0hrdFGlOd0",
    authDomain: "openchat2.firebaseapp.com",
    databaseURL: "https://openchat2-default-rtdb.firebaseio.com",
    projectId: "openchat2",
    storageBucket: "openchat2.appspot.com",
    messagingSenderId: "1046412600695",
    appId: "1:1046412600695:web:28f6c20c997c7e6d3aed72",
    measurementId: "G-KE583G0DX7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  let username = "";
  const adminUsername = "Admin";
  let reloadInitialized = false;
  let darkMode = false;
  let autoScroll = true;

  // Eğer localStorage’da 'rememberUser' varsa otomatik giriş
  window.onload = () => {
    const rem = localStorage.getItem('rememberUser');
    if (rem) {
      loginUser(rem);
    }
    // Duyuruları dinle
    db.ref("announcements").on("child_added", snapshot => {
      const data = snapshot.val();
      const annDiv = document.createElement("div");
      annDiv.className = "message";
      annDiv.innerHTML = `
        <div class="header">
          <span style="color:#faa61a">[DUYURU]</span>
          <span class="time">${new Date(data.timestamp).toLocaleString("tr-TR", {
            hour: "2-digit", minute: "2-digit",
            day: "2-digit", month: "2-digit", year: "numeric"
          })}</span>
        </div>
        <div class="content">${data.message}</div>
      `;
      document.getElementById("messages").prepend(annDiv);
    });
  };

  // --- Kullanıcı Durumunu İzleme (Çevrimiçi/Çevrimdışı) ---
  function setOnlineStatus(isOnline) {
    if (username) {
      db.ref('users/' + username).update({ online: isOnline });
    }
  }
  window.addEventListener('beforeunload', () => {
    setOnlineStatus(false);
  });

  // --- Kayıt ---
  function register() {
    const user = document.getElementById("authUsername").value.trim();
    const pass = document.getElementById("authPassword").value.trim();
    if (!user || !pass) {
      showError("Lütfen tüm alanları doldurun.");
      return;
    }
    db.ref("users/" + user).once("value", snapshot => {
      if (snapshot.exists()) {
        showError("Bu kullanıcı adı zaten kullanılıyor.");
      } else {
        const defaultAvatar = ""; // Profil resimleri kaldırıldı
        db.ref("users/" + user).set({
          password: pass,
          avatar: defaultAvatar,
          online: false,
          favorites: {},
          isAdmin: false,
          banned: false,
          mutedUntil: 0,
          registerDate: Date.now(),
          totalMessages: 0
        }, () => {
          if (document.getElementById('rememberMeLogin').checked) {
            localStorage.setItem('rememberUser', user);
          }
          loginUser(user);
        });
      }
    });
  }

  // --- Giriş ---
  function login() {
    const user = document.getElementById("authUsername").value.trim();
    const pass = document.getElementById("authPassword").value.trim();
    if (!user || !pass) {
      showError("Lütfen tüm alanları doldurun.");
      return;
    }
    db.ref("users/" + user).once("value", snapshot => {
      if (snapshot.exists() && snapshot.val().password === pass) {
        if (snapshot.val().banned) {
          alert("Hesabınız banlanmış.");
          return;
        }
        if (document.getElementById('rememberMeLogin').checked) {
          localStorage.setItem('rememberUser', user);
        }
        loginUser(user);
      } else {
        showError("Geçersiz kullanıcı adı veya şifre.");
      }
    });
  }

  function showError(msg) {
    document.getElementById("authError").innerText = msg;
  }

  // --- Giriş İşlemi ---
  function loginUser(user) {
    username = user;
    document.getElementById("authModal").style.display = "none";
    document.getElementById("chat").style.display = "flex";

    document.getElementById("userControls").style.display = "flex";
    if (username === adminUsername) {
      document.getElementById("toggleAdminBtn").style.display = "inline-block";
    }

    setOnlineStatus(true);

    loadMessages();
    listenForDeletesAndEdits();
    listenForReloadCommand();

    document.getElementById("messageInput").addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        send();
      }
    });
  }

  // --- Oturumu Kapat ---
  function logout() {
    setOnlineStatus(false);
    localStorage.removeItem('rememberUser');
    username = "";
    location.reload();
  }

  // --- Mesaj Gönderme ---
  function send() {
    const msg = document.getElementById("messageInput").value.trim();
    if (!msg) return;
    // Chat kilitli mi?
    db.ref("chatLock").once("value", snap => {
      if (snap.exists() && snap.val() === true && username !== adminUsername) {
        alert("Sohbet kilitli; mesaj gönderemezsiniz.");
        return;
      }
      // Sessize alındı mı?
      db.ref("users/" + username + "/mutedUntil").once("value", mSnap => {
        const mutedUntil = mSnap.val() || 0;
        if (Date.now() < mutedUntil) {
          alert("Sessize alındınız; bekleyin.");
          return;
        }
        // Küfür filtreleme
        const badWords = ["küfür1","küfür2"];
        let filtered = msg;
        badWords.forEach(w => {
          const rx = new RegExp(w, "gi");
          filtered = filtered.replace(rx, "***");
        });
        // Mesaj sayısı arttır
        db.ref("users/" + username + "/totalMessages").transaction(n => (n || 0) + 1);
        const messageData = {
          username: username,
          message: filtered,
          timestamp: Date.now()
        };
        db.ref("messages_global").push(messageData);
        document.getElementById("messageInput").value = "";
      });
    });
  }

  // --- Mesajları Yükleme ve Dinleme ---
  function loadMessages() {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    db.ref("messages_global").on("child_added", snapshot => {
      addOrUpdateMessage(snapshot.key, snapshot.val());
    });
  }

  function addOrUpdateMessage(key, val) {
    const messagesDiv = document.getElementById("messages");
    let msgDiv = document.getElementById("msg-" + key);

    if (!msgDiv) {
      msgDiv = document.createElement("div");
      msgDiv.className = "message";
      msgDiv.id = "msg-" + key;
      messagesDiv.appendChild(msgDiv);
    }

    const headerDiv = document.createElement("div");
    headerDiv.className = "header";

    const userSpan = document.createElement("span");
    userSpan.className = "author";
    userSpan.innerText = (val.username === adminUsername ? "[ADMİN] " : "") + val.username;
    userSpan.onclick = (e) => showProfilePopup(val.username, e.pageX, e.pageY);

    const timeSpan = document.createElement("span");
    timeSpan.className = "time";
    const date = new Date(val.timestamp);
    timeSpan.innerText = date.toLocaleString("tr-TR", {
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    });

    headerDiv.appendChild(userSpan);
    headerDiv.appendChild(timeSpan);

    const contentDiv = document.createElement("div");
    contentDiv.className = "content";
    contentDiv.innerText = val.message;

    if (val.message.includes("@" + username)) {
      msgDiv.classList.add("mention");
      document.getElementById("mentionSound").play().catch(()=>{});
      showMentionPopup();
    } else {
      msgDiv.classList.remove("mention");
    }

    const actionsDiv = document.createElement("div");
    actionsDiv.className = "actions";
    if (val.username === username || username === adminUsername) {
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-btn";
      deleteBtn.innerText = "Sil";
      deleteBtn.onclick = () => db.ref("messages_global/" + key).remove();

      const editBtn = document.createElement("button");
      editBtn.className = "edit-btn";
      editBtn.innerText = "Düzenle";
      editBtn.onclick = () => {
        const newMessage = prompt("Yeni mesajı girin:", val.message);
        if (newMessage && newMessage.trim() !== "") {
          db.ref("messages_global/" + key).update({ message: newMessage.trim() });
        }
      };

      actionsDiv.appendChild(deleteBtn);
      actionsDiv.appendChild(editBtn);
    }

    msgDiv.innerHTML = "";
    msgDiv.appendChild(headerDiv);
    msgDiv.appendChild(contentDiv);
    msgDiv.appendChild(actionsDiv);

    if (autoScroll) messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // --- Silme ve Düzenleme Dinleme ---
  function listenForDeletesAndEdits() {
    db.ref("messages_global").on("child_removed", snapshot => {
      const msgDiv = document.getElementById("msg-" + snapshot.key);
      if (msgDiv) msgDiv.remove();
    });
    db.ref("messages_global").on("child_changed", snapshot => {
      addOrUpdateMessage(snapshot.key, snapshot.val());
    });
  }

  // --- Admin: Tüm Mesajları Sil ---
  function deleteAllMessages() {
    if (confirm("Sohbetteki tüm mesajları silmek istediğinizden emin misiniz?")) {
      db.ref("messages_global").remove();
    }
  }

  // --- Siteyi Yenile Komutu (Admin) ---
  function triggerReloadCommand() {
    db.ref("reload_commands").push({ timestamp: Date.now() });
  }
  function listenForReloadCommand() {
    const reloadRef = db.ref("reload_commands");
    reloadRef.once("value", () => { reloadInitialized = true; });
    reloadRef.on("child_added", snapshot => {
      if (reloadInitialized) {
        alert("Yönetici sayfayı yeniledi, sayfa yeniden yüklenecek.");
        location.reload();
      }
    });
  }

  // --- Tema Değiştir ---
  function toggleTheme() {
    darkMode = !darkMode;
    if (darkMode) {
      document.body.style.backgroundColor = "#f4f4f4";
      document.body.style.color = "#222";
    } else {
      document.body.style.backgroundColor = "#1e2124";
      document.body.style.color = "#e1e3e5";
    }
  }

  // --- Admin Modal Göster/Gizle ---
  function openAdminModal() {
    document.getElementById("adminModal").style.display = "flex";
  }
  function closeAdminModal() {
    document.getElementById("adminModal").style.display = "none";
  }

  // --- Profil Popup ---
  function showProfilePopup(user, x, y) {
    db.ref("users/" + user).once("value", snap => {
      const data = snap.val() || {};
      const popup = document.getElementById("profilePopup");
      popup.innerHTML = `
        <div class="username">${user}</div>
        <div class="status">${data.online ? "🟢 Online" : "⚪ Offline"}</div>
        <button onclick="startPrivateChat('${user}')">Özel Mesaj Gönder</button>
        <button onclick="closeProfilePopup()">Kapat</button>
      `;
      popup.style.left = x + "px";
      popup.style.top = y + "px";
      popup.style.display = "block";
      setTimeout(() => {
        document.addEventListener("click", hideProfilePopupOnce);
      }, 100);
    });
  }
  function hideProfilePopupOnce() {
    document.getElementById("profilePopup").style.display = "none";
    document.removeEventListener("click", hideProfilePopupOnce);
  }
  function closeProfilePopup() {
    document.getElementById("profilePopup").style.display = "none";
  }

  function sanitizeKey(key) {
    return key.replace(/[^a-zA-Z0-9_-]/g, '');
  }

  // --- Özel Mesajlaşma (DM) ---
  function startPrivateChat(targetUser) {
    const threadKey = [sanitizeKey(username), sanitizeKey(targetUser)].sort().join("_");
    openPrivateChatWindow(targetUser, threadKey);
  }

  function openPrivateChatWindow(targetUser, threadKey) {
    document.getElementById("chat").style.display = "none";
    let privateDiv = document.getElementById("privateChat");
    if (!privateDiv) {
      privateDiv = document.createElement("div");
      privateDiv.id = "privateChat";
      privateDiv.style = "display:flex; flex-direction:column; height:100vh; background:#1e2124; color:#e1e3e5;";
      privateDiv.innerHTML = `
        <button class="startChatBtn" onclick="promptNewChat()">Sohbete Başla</button>
        <div class="header">
          <span>Özel Sohbet: ${targetUser}</span>
          <button onclick="closePrivateChat()">✖ İptal</button>
        </div>
        <div class="messages" id="privateMessages"></div>
        <div class="inputArea">
          <input id="privateInput" placeholder="Mesajınızı yazın..." />
          <button onclick="sendPrivateMessage('${threadKey}','${targetUser}')">Gönder</button>
        </div>
      `;
      document.body.appendChild(privateDiv);
    } else {
      privateDiv.querySelector(".header span").innerText = "Özel Sohbet: " + targetUser;
      document.getElementById("privateMessages").innerHTML = "";
      privateDiv.style.display = "flex";
    }

    const pmDiv = document.getElementById("privateMessages");
    pmDiv.innerHTML = "";
    db.ref(`private_messages/${threadKey}`).off();
    db.ref(`private_messages/${threadKey}`).on("child_added", snap => {
      const val = snap.val();
      const msgEl = document.createElement("div");
      msgEl.className = "msg";
      msgEl.innerHTML = `
        <div class="header">
          <span>${val.username}</span>
          <span class="read-status">${val.read ? '✓ Okundu' : '✉ Gönderildi'}</span>
        </div>
        <div class="content">${val.message}</div>
      `;
      pmDiv.appendChild(msgEl);
      pmDiv.scrollTop = pmDiv.scrollHeight;
      if (!val.read) {
        snap.ref.update({ read: true });
      }
    });
  }

  function promptNewChat() {
    const other = prompt("Sohbet başlatmak istediğiniz kullanıcı adı:");
    if (!other) return;
    if (other === username) {
      alert("Kendinize DM gönderemezsiniz.");
      return;
    }
    db.ref("users/" + other).once("value", snap => {
      if (snap.exists()) {
        startPrivateChat(other);
      } else {
        alert("Kullanıcı bulunamadı.");
      }
    });
  }

  function sendPrivateMessage(threadKey, targetUser) {
    const input = document.getElementById("privateInput");
    const msg = input.value.trim();
    if (!msg) return;
    db.ref("users/" + username + "/mutedUntil").once("value", mSnap => {
      const mutedUntil = mSnap.val() || 0;
      if (Date.now() < mutedUntil) {
        alert("Sessize alındınız; DM gönderemezsiniz.");
        return;
      }
      db.ref(`private_messages/${threadKey}`).push({
        username: username,
        message: msg,
        timestamp: Date.now(),
        read: false
      });
      input.value = "";
    });
  }

  function closePrivateChat() {
    const privateDiv = document.getElementById("privateChat");
    if (privateDiv) privateDiv.style.display = "none";
    document.getElementById("chat").style.display = "flex";
  }

  // --- Şifre Değiştir ---
  function openChangePasswordPopup() {
    document.getElementById("changePasswordPopup").style.display = "flex";
  }
  function closeChangePasswordPopup() {
    document.getElementById("changePasswordPopup").style.display = "none";
    document.getElementById("changePassError").innerText = "";
    document.getElementById("oldPassword").value = "";
    document.getElementById("newPassword").value = "";
  }
  function changePassword() {
    const oldPass = document.getElementById("oldPassword").value.trim();
    const newPass = document.getElementById("newPassword").value.trim();
    if (!oldPass || !newPass) {
      document.getElementById("changePassError").innerText = "Lütfen tüm alanları doldurun.";
      return;
    }
    db.ref("users/" + username).once("value", snapshot => {
      if (snapshot.exists() && snapshot.val().password === oldPass) {
        db.ref("users/" + username).update({ password: newPass }, () => {
          alert("Şifreniz başarıyla değiştirildi.");
          closeChangePasswordPopup();
        });
      } else {
        document.getElementById("changePassError").innerText = "Eski şifre hatalı.";
      }
    });
  }

  // --- Mesajlarım Popup ---
  function openMyMessagesPopup() {
    document.getElementById("myMessagesPopup").style.display = "flex";
    loadMyMessages();
  }
  function closeMyMessagesPopup() {
    document.getElementById("myMessagesPopup").style.display = "none";
  }
  function loadMyMessages() {
    const container = document.getElementById("myMessagesContent");
    container.innerHTML = "";
    db.ref("private_messages").once("value", snapshot => {
      if (!snapshot.exists()) {
        container.innerHTML = "<p>Henüz özel mesajınız yok.</p>";
        return;
      }
      const threads = snapshot.val();
      const myKey = sanitizeKey(username);
      let foundAny = false;
      Object.keys(threads).forEach(threadKey => {
        if (threadKey.includes(myKey)) {
          foundAny = true;
          const parts = threadKey.split("_");
          const other = parts[0] === myKey ? parts[1] : parts[0];
          const threadDiv = document.createElement("div");
          threadDiv.className = "thread";
          const unreadCount = Object.values(threads[threadKey]).filter(m => !m.read && m.username !== username).length;
          threadDiv.innerHTML = `
            <span>${other} ile sohbet</span>
            ${unreadCount ? `<span class="badge">${unreadCount}</span>` : ""}
          `;
          threadDiv.onclick = () => {
            closeMyMessagesPopup();
            openPrivateChatWindow(other, threadKey);
          };
          container.appendChild(threadDiv);
        }
      });
      if (!foundAny) {
        container.innerHTML = "<p>Henüz özel mesajınız yok.</p>";
      }
    });
  }

  // --- Mesaj Arama ---
  function searchMessages() {
    const query = document.getElementById("searchInput").value.toLowerCase();
    const msgs = document.querySelectorAll("#messages .message");
    msgs.forEach(msg => {
      const text = msg.querySelector(".content").innerText.toLowerCase();
      msg.style.display = text.includes(query) ? "block" : "none";
    });
  }

  // --- Mention Popup Göster/Gizle ---
  function showMentionPopup() {
    const popup = document.getElementById("mentionPopup");
    popup.style.display = "block";
    setTimeout(() => {
      popup.style.display = "none";
    }, 3000);
  }

  // --- Admin İşlevleri ---
  // Ban Listesi
  function openBanList() {
    const popup = document.getElementById("banListPopup");
    const listDiv = document.getElementById("bannedUsersList");
    listDiv.innerHTML = "";
    db.ref("users").once("value", snap => {
      const users = snap.val() || {};
      Object.keys(users).forEach(u => {
        if (users[u].banned) {
          const item = document.createElement("div");
          item.className = "user-item";
          item.innerHTML = `<span>${u}</span><button onclick="unbanUser('${u}')">Ban Kaldır</button>`;
          listDiv.appendChild(item);
        }
      });
      if (listDiv.innerHTML === "") {
        listDiv.innerHTML = "<p>Banlı kullanıcı yok.</p>";
      }
      popup.style.display = "flex";
    });
  }
  function closeBanList() {
    document.getElementById("banListPopup").style.display = "none";
  }
  function unbanUser(u) {
    db.ref("users/" + u).update({ banned: false });
    openBanList();
  }

  // Sessize Alma
  function openMutePopup() {
    document.getElementById("muteError").innerText = "";
    document.getElementById("muteUsername").value = "";
    document.getElementById("muteDuration").value = "";
    document.getElementById("mutePopup").style.display = "flex";
  }
  function closeMutePopup() {
    document.getElementById("mutePopup").style.display = "none";
  }
  function confirmMute() {
    const u = document.getElementById("muteUsername").value.trim();
    const dur = parseInt(document.getElementById("muteDuration").value);
    if (!u || !dur || dur <= 0) {
      document.getElementById("muteError").innerText = "Geçerli değer girin.";
      return;
    }
    db.ref("users/" + u).once("value", snap => {
      if (snap.exists()) {
        const until = Date.now() + dur * 60000;
        db.ref("users/" + u).update({ mutedUntil: until });
        alert(`${u} ${dur} dakika boyunca sessize alındı.`);
        closeMutePopup();
      } else {
        document.getElementById("muteError").innerText = "Kullanıcı bulunamadı.";
      }
    });
  }

  // Kullanıcı Bilgisi Görüntüle
  function openUserInfo() {
    const target = prompt("Bilgilerini görüntülemek istediğiniz kullanıcı adı:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        const data = snap.val();
        const content = document.getElementById("userInfoContent");
        const regDate = new Date(data.registerDate || 0).toLocaleString("tr-TR", {
          day: "2-digit", month: "2-digit", year: "numeric",
          hour: "2-digit", minute: "2-digit"
        });
        content.innerHTML = `
          <p><strong>Kullanıcı:</strong> ${target}</p>
          <p><strong>Kayıt Tarihi:</strong> ${regDate}</p>
          <p><strong>Çevrimiçi:</strong> ${data.online ? 'Evet' : 'Hayır'}</p>
          <p><strong>Toplam Mesaj:</strong> ${data.totalMessages || 0}</p>
          <p><strong>Banlı:</strong> ${data.banned ? 'Evet' : 'Hayır'}</p>
          <p><strong>Sessize Alındı mı:</strong> ${Date.now() < (data.mutedUntil || 0) ? 'Evet' : 'Hayır'}</p>
        `;
        document.getElementById("userInfoPopup").style.display = "flex";
      } else {
        alert("Kullanıcı bulunamadı.");
      }
    });
  }
  function closeUserInfoPopup() {
    document.getElementById("userInfoPopup").style.display = "none";
  }

  // Banla (tek kullanıcı)
  function banUser() {
    const target = prompt("Banlanacak kullanıcı adı:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        db.ref("users/" + target).update({ banned: true });
        alert("Kullanıcı banlandı.");
      } else {
        alert("Kullanıcı bulunamadı.");
      }
    });
  }

  // Sohbet Kilitle
  function lockChat() {
    db.ref("chatLock").once("value", snap => {
      if (snap.exists() && snap.val() === true) {
        db.ref("chatLock").set(false);
        alert("Sohbet kilidi kaldırıldı.");
      } else {
        db.ref("chatLock").set(true);
        alert("Sohbet kilitlendi.");
      }
    });
  }

  // Duyuru Gönder
  function announce() {
    const ann = prompt("Duyuru mesajı:");
    if (!ann) return;
    db.ref("announcements").push({ message: ann, timestamp: Date.now() });
    alert("Duyuru gönderildi.");
  }

  // Admin Yetkisi Ver
  function grantAdmin() {
    const target = prompt("Admin yetkisi verilecek kullanıcı adı:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        db.ref("users/" + target).update({ isAdmin: true });
        alert("Kullanıcıya admin yetkisi verildi.");
      } else {
        alert("Kullanıcı bulunamadı.");
      }
    });
  }

  // Aktif Kullanıcı Sayısı
  function viewChatCount() {
    db.ref("users").once("value", snap => {
      const users = snap.val() || {};
      const onlineCount = Object.values(users).filter(u => u.online).length;
      alert("Çevrimiçi kullanıcı sayısı: " + onlineCount);
    });
  }

  // DM Oku/Düzenle/Sil (basit listeleme)
  function viewDMAdmin() {
    db.ref("private_messages").once("value", snap => {
      if (!snap.exists()) {
        alert("Hiç DM yok.");
        return;
      }
      let list = "";
      snap.forEach(threadSnap => {
        const threadKey = threadSnap.key;
        threadSnap.forEach(msgSnap => {
          const d = msgSnap.val();
          list += `${threadKey} → ${d.username}: ${d.message}\n`;
        });
      });
      alert("Tüm DM’ler:\n\n" + list);
    });
  }

  // Admin Şifre Değiştir (DB üzerinden)
  function adminChangePassword() {
    const target = prompt("Şifresi değiştirilecek kullanıcı adı:");
    const newPass = prompt("Yeni şifre:");
    if (!target || !newPass) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists()) {
        db.ref("users/" + target).update({ password: newPass });
        alert("Kullanıcının şifresi güncellendi.");
      } else {
        alert("Kullanıcı bulunamadı.");
      }
    });
  }

  // Hesabına Gir (impersonate)
  function impersonate() {
    const target = prompt("Hesabına girilecek kullanıcı adı:");
    if (!target) return;
    db.ref("users/" + target).once("value", snap => {
      if (snap.exists() && !snap.val().banned) {
        // Özet: mevcut oturumu kapatıp, diğer kullanıcı gibi yeniden başlat
        localStorage.setItem('rememberUser', target);
        loginUser(target);
      } else {
        alert("Kullanıcı bulunamadı veya banlı.");
      }
    });
  }
</script>

</body>
</html>